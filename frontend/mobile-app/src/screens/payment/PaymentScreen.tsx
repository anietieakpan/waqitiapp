import React, { useState, useRef } from 'react';
import {
  View,
  ScrollView,
  StyleSheet,
  TouchableOpacity,
  Dimensions,
  Animated,
} from 'react-native';
import {
  Text,
  useTheme,
  Surface,
  FAB,
  IconButton,
  Chip,
  Avatar,
} from 'react-native-paper';
import { useNavigation } from '@react-navigation/native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { useSelector } from 'react-redux';
import LinearGradient from 'react-native-linear-gradient';
import Icon from 'react-native-vector-icons/MaterialCommunityIcons';
import { RootState } from '../../store/store';
import Header from '../../components/common/Header';
import { formatCurrency } from '../../utils/formatters';

const { width: screenWidth } = Dimensions.get('window');

interface QuickAction {
  id: string;
  title: string;
  subtitle: string;
  icon: string;
  color: string;
  gradient: string[];
  action: () => void;
}

interface RecentContact {
  id: string;
  name: string;
  avatar?: string;
  lastTransaction: string;
}

/**
 * Payment Screen - Central hub for all payment actions
 */
const PaymentScreen: React.FC = () => {
  const theme = useTheme();
  const navigation = useNavigation();
  const wallet = useSelector((state: RootState) => state.wallet);
  const user = useSelector((state: RootState) => state.auth.user);
  
  const [selectedTab, setSelectedTab] = useState<'send' | 'request' | 'split'>('send');\n  const scrollX = useRef(new Animated.Value(0)).current;\n  const scrollViewRef = useRef<ScrollView>(null);\n\n  // Mock recent contacts data\n  const recentContacts: RecentContact[] = [\n    { id: '1', name: 'Alice Johnson', lastTransaction: '2 days ago' },\n    { id: '2', name: 'Bob Smith', lastTransaction: '1 week ago' },\n    { id: '3', name: 'Carol Wilson', lastTransaction: '3 days ago' },\n    { id: '4', name: 'David Brown', lastTransaction: '1 day ago' },\n    { id: '5', name: 'Eva Davis', lastTransaction: '5 days ago' },\n  ];\n\n  const quickActions: QuickAction[] = [\n    {\n      id: 'send',\n      title: 'Send Money',\n      subtitle: 'Transfer to contacts',\n      icon: 'send',\n      color: theme.colors.primary,\n      gradient: [theme.colors.primary, '#667eea'],\n      action: () => navigation.navigate('SendMoney' as never),\n    },\n    {\n      id: 'request',\n      title: 'Request Money',\n      subtitle: 'Ask for payment',\n      icon: 'call-received',\n      color: theme.colors.secondary,\n      gradient: [theme.colors.secondary, '#764ba2'],\n      action: () => navigation.navigate('RequestMoney' as never),\n    },\n    {\n      id: 'scan',\n      title: 'Scan QR Code',\n      subtitle: 'Pay with QR',\n      icon: 'qrcode-scan',\n      color: '#4CAF50',\n      gradient: ['#4CAF50', '#45a049'],\n      action: () => navigation.navigate('ScanQR' as never),\n    },\n    {\n      id: 'split',\n      title: 'Split Bill',\n      subtitle: 'Share expenses',\n      icon: 'account-group',\n      color: '#FF9800',\n      gradient: ['#FF9800', '#F57C00'],\n      action: () => navigation.navigate('SplitBill' as never),\n    },\n    {\n      id: 'nfc',\n      title: 'Tap to Pay',\n      subtitle: 'Contactless payment',\n      icon: 'contactless-payment',\n      color: '#9C27B0',\n      gradient: ['#9C27B0', '#7B1FA2'],\n      action: () => navigation.navigate('NFCPayment' as never),\n    },\n    {\n      id: 'nearby',\n      title: 'Nearby',\n      subtitle: 'Find merchants',\n      icon: 'map-marker',\n      color: '#FF5722',\n      gradient: ['#FF5722', '#E64A19'],\n      action: () => navigation.navigate('NearbyPayment' as never),\n    },\n  ];\n\n  const handleTabChange = (tab: 'send' | 'request' | 'split') => {\n    setSelectedTab(tab);\n    const index = ['send', 'request', 'split'].indexOf(tab);\n    scrollViewRef.current?.scrollTo({\n      x: index * screenWidth,\n      animated: true,\n    });\n  };\n\n  const handleScroll = Animated.event(\n    [{ nativeEvent: { contentOffset: { x: scrollX } } }],\n    {\n      useNativeDriver: false,\n      listener: (event: any) => {\n        const offsetX = event.nativeEvent.contentOffset.x;\n        const index = Math.round(offsetX / screenWidth);\n        const tabs = ['send', 'request', 'split'] as const;\n        setSelectedTab(tabs[index]);\n      },\n    }\n  );\n\n  const handleContactPress = (contact: RecentContact) => {\n    if (selectedTab === 'send') {\n      navigation.navigate('SendMoney', { recipientId: contact.id } as never);\n    } else if (selectedTab === 'request') {\n      navigation.navigate('RequestMoney', { senderId: contact.id } as never);\n    }\n  };\n\n  const renderQuickAction = (action: QuickAction) => (\n    <TouchableOpacity\n      key={action.id}\n      style={styles.quickActionCard}\n      onPress={action.action}\n    >\n      <LinearGradient\n        colors={action.gradient}\n        style={styles.quickActionGradient}\n        start={{ x: 0, y: 0 }}\n        end={{ x: 1, y: 1 }}\n      >\n        <Icon name={action.icon} size={32} color=\"white\" />\n        <Text style={styles.quickActionTitle}>{action.title}</Text>\n        <Text style={styles.quickActionSubtitle}>{action.subtitle}</Text>\n      </LinearGradient>\n    </TouchableOpacity>\n  );\n\n  const renderContactTab = (tabType: 'send' | 'request' | 'split') => (\n    <View key={tabType} style={styles.contactsTab}>\n      <ScrollView\n        contentContainerStyle={styles.contactsGrid}\n        showsVerticalScrollIndicator={false}\n      >\n        {recentContacts.map((contact) => (\n          <TouchableOpacity\n            key={contact.id}\n            style={styles.contactCard}\n            onPress={() => handleContactPress(contact)}\n          >\n            <Avatar.Text\n              size={48}\n              label={contact.name.split(' ').map(n => n[0]).join('')}\n              style={styles.contactAvatar}\n            />\n            <Text style={styles.contactName} numberOfLines={1}>\n              {contact.name}\n            </Text>\n            <Text style={styles.contactLastTransaction}>\n              {contact.lastTransaction}\n            </Text>\n          </TouchableOpacity>\n        ))}\n        \n        <TouchableOpacity\n          style={styles.contactCard}\n          onPress={() => navigation.navigate('Contacts' as never)}\n        >\n          <Surface style={styles.addContactButton} elevation={2}>\n            <Icon name=\"plus\" size={24} color={theme.colors.primary} />\n          </Surface>\n          <Text style={styles.contactName}>Add Contact</Text>\n          <Text style={styles.contactLastTransaction}>Find more</Text>\n        </TouchableOpacity>\n      </ScrollView>\n    </View>\n  );\n\n  return (\n    <View style={styles.container}>\n      <Header\n        title=\"Payment\"\n        subtitle={`Balance: ${formatCurrency(wallet.balance, wallet.currency)}`}\n        rightAction={\n          <IconButton\n            icon=\"history\"\n            size={24}\n            onPress={() => navigation.navigate('TransactionHistory' as never)}\n          />\n        }\n      />\n\n      <ScrollView\n        style={styles.scrollView}\n        contentContainerStyle={styles.scrollContent}\n        showsVerticalScrollIndicator={false}\n      >\n        {/* Quick Actions Grid */}\n        <View style={styles.section}>\n          <Text style={styles.sectionTitle}>Quick Actions</Text>\n          <View style={styles.quickActionsGrid}>\n            {quickActions.map(renderQuickAction)}\n          </View>\n        </View>\n\n        {/* Recent Contacts Section */}\n        <View style={styles.section}>\n          <View style={styles.sectionHeader}>\n            <Text style={styles.sectionTitle}>Recent Contacts</Text>\n            <TouchableOpacity onPress={() => navigation.navigate('Contacts' as never)}>\n              <Text style={styles.seeAllText}>See all</Text>\n            </TouchableOpacity>\n          </View>\n\n          {/* Tab Navigation */}\n          <View style={styles.tabNavigation}>\n            {['send', 'request', 'split'].map((tab) => (\n              <TouchableOpacity\n                key={tab}\n                style={[\n                  styles.tab,\n                  selectedTab === tab && styles.activeTab,\n                ]}\n                onPress={() => handleTabChange(tab as any)}\n              >\n                <Text\n                  style={[\n                    styles.tabText,\n                    selectedTab === tab && styles.activeTabText,\n                  ]}\n                >\n                  {tab.charAt(0).toUpperCase() + tab.slice(1)}\n                </Text>\n              </TouchableOpacity>\n            ))}\n          </View>\n\n          {/* Contact Tabs Content */}\n          <ScrollView\n            ref={scrollViewRef}\n            horizontal\n            pagingEnabled\n            showsHorizontalScrollIndicator={false}\n            onScroll={handleScroll}\n            scrollEventThrottle={16}\n            style={styles.contactsScrollView}\n          >\n            {renderContactTab('send')}\n            {renderContactTab('request')}\n            {renderContactTab('split')}\n          </ScrollView>\n        </View>\n\n        {/* Recent Activity */}\n        <View style={styles.section}>\n          <View style={styles.sectionHeader}>\n            <Text style={styles.sectionTitle}>Payment Methods</Text>\n            <TouchableOpacity onPress={() => navigation.navigate('LinkedAccounts' as never)}>\n              <Text style={styles.seeAllText}>Manage</Text>\n            </TouchableOpacity>\n          </View>\n          \n          <Surface style={styles.paymentMethodCard} elevation={1}>\n            <View style={styles.paymentMethod}>\n              <Icon name=\"credit-card\" size={32} color={theme.colors.primary} />\n              <View style={styles.paymentMethodInfo}>\n                <Text style={styles.paymentMethodTitle}>Visa •••• 4242</Text>\n                <Text style={styles.paymentMethodSubtitle}>Primary card</Text>\n              </View>\n              <IconButton icon=\"chevron-right\" size={20} />\n            </View>\n          </Surface>\n\n          <Surface style={styles.paymentMethodCard} elevation={1}>\n            <View style={styles.paymentMethod}>\n              <Icon name=\"bank\" size={32} color={theme.colors.secondary} />\n              <View style={styles.paymentMethodInfo}>\n                <Text style={styles.paymentMethodTitle}>Chase Bank</Text>\n                <Text style={styles.paymentMethodSubtitle}>•••• 8901</Text>\n              </View>\n              <IconButton icon=\"chevron-right\" size={20} />\n            </View>\n          </Surface>\n        </View>\n      </ScrollView>\n\n      {/* Floating Action Button */}\n      <FAB\n        icon=\"qrcode\"\n        style={styles.fab}\n        onPress={() => navigation.navigate('QRCodeGenerator' as never)}\n      />\n    </View>\n  );\n};\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    backgroundColor: '#f5f5f5',\n  },\n  scrollView: {\n    flex: 1,\n  },\n  scrollContent: {\n    paddingBottom: 100,\n  },\n  section: {\n    marginTop: 24,\n    paddingHorizontal: 16,\n  },\n  sectionHeader: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    alignItems: 'center',\n    marginBottom: 16,\n  },\n  sectionTitle: {\n    fontSize: 18,\n    fontWeight: '600',\n    color: '#333',\n  },\n  seeAllText: {\n    fontSize: 14,\n    color: '#2196F3',\n  },\n  quickActionsGrid: {\n    flexDirection: 'row',\n    flexWrap: 'wrap',\n    gap: 12,\n  },\n  quickActionCard: {\n    width: (screenWidth - 48 - 12) / 2,\n    height: 120,\n    borderRadius: 16,\n    overflow: 'hidden',\n  },\n  quickActionGradient: {\n    flex: 1,\n    padding: 16,\n    justifyContent: 'center',\n    alignItems: 'center',\n  },\n  quickActionTitle: {\n    color: 'white',\n    fontSize: 16,\n    fontWeight: 'bold',\n    marginTop: 8,\n    textAlign: 'center',\n  },\n  quickActionSubtitle: {\n    color: 'rgba(255, 255, 255, 0.8)',\n    fontSize: 12,\n    marginTop: 4,\n    textAlign: 'center',\n  },\n  tabNavigation: {\n    flexDirection: 'row',\n    backgroundColor: '#f0f0f0',\n    borderRadius: 12,\n    padding: 4,\n    marginBottom: 16,\n  },\n  tab: {\n    flex: 1,\n    paddingVertical: 12,\n    paddingHorizontal: 16,\n    borderRadius: 8,\n    alignItems: 'center',\n  },\n  activeTab: {\n    backgroundColor: 'white',\n    elevation: 2,\n  },\n  tabText: {\n    fontSize: 14,\n    fontWeight: '500',\n    color: '#666',\n  },\n  activeTabText: {\n    color: '#333',\n  },\n  contactsScrollView: {\n    height: 200,\n  },\n  contactsTab: {\n    width: screenWidth - 32,\n    height: 200,\n  },\n  contactsGrid: {\n    flexDirection: 'row',\n    flexWrap: 'wrap',\n    gap: 12,\n  },\n  contactCard: {\n    width: (screenWidth - 48 - 24) / 3,\n    alignItems: 'center',\n    padding: 8,\n  },\n  contactAvatar: {\n    marginBottom: 8,\n  },\n  addContactButton: {\n    width: 48,\n    height: 48,\n    borderRadius: 24,\n    justifyContent: 'center',\n    alignItems: 'center',\n    marginBottom: 8,\n    backgroundColor: '#f5f5f5',\n  },\n  contactName: {\n    fontSize: 12,\n    fontWeight: '500',\n    color: '#333',\n    textAlign: 'center',\n    marginBottom: 4,\n  },\n  contactLastTransaction: {\n    fontSize: 10,\n    color: '#666',\n    textAlign: 'center',\n  },\n  paymentMethodCard: {\n    marginBottom: 8,\n    borderRadius: 12,\n    backgroundColor: 'white',\n  },\n  paymentMethod: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    padding: 16,\n  },\n  paymentMethodInfo: {\n    flex: 1,\n    marginLeft: 16,\n  },\n  paymentMethodTitle: {\n    fontSize: 16,\n    fontWeight: '500',\n    color: '#333',\n  },\n  paymentMethodSubtitle: {\n    fontSize: 14,\n    color: '#666',\n    marginTop: 4,\n  },\n  fab: {\n    position: 'absolute',\n    margin: 16,\n    right: 0,\n    bottom: 0,\n  },\n});\n\nexport default PaymentScreen;