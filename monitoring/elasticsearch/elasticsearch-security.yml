# Elasticsearch Security Configuration for Waqiti Platform
# Production-ready security settings with X-Pack Security

cluster.name: "waqiti-elasticsearch"
node.name: "waqiti-es-node-${NODE_ID}"

# Network settings
network.host: 0.0.0.0
http.port: 9200
transport.tcp.port: 9300

# Discovery settings for clustering
discovery.seed_hosts:
  - elasticsearch-master-0.elasticsearch-headless.monitoring.svc.cluster.local:9300
  - elasticsearch-master-1.elasticsearch-headless.monitoring.svc.cluster.local:9300
  - elasticsearch-master-2.elasticsearch-headless.monitoring.svc.cluster.local:9300

cluster.initial_master_nodes:
  - elasticsearch-master-0
  - elasticsearch-master-1
  - elasticsearch-master-2

# Security Configuration - X-Pack Security ENABLED
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
xpack.security.http.ssl.enabled: true

# SSL/TLS Configuration
xpack.security.transport.ssl.verification_mode: certificate
xpack.security.transport.ssl.client_authentication: required
xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-stack-ca.p12
xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-stack-ca.p12

xpack.security.http.ssl.enabled: true
xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elasticsearch.p12
xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-stack-ca.p12
xpack.security.http.ssl.client_authentication: optional

# Authentication and Authorization
xpack.security.authc.realms:
  native.native1:
    order: 0
    enabled: true
  
  oidc.oidc1:
    order: 1
    rp.client_id: "elasticsearch"
    rp.response_type: "code"
    rp.redirect_uri: "https://logs.example.com/api/security/oidc/callback"
    op.issuer: "https://auth.example.com/realms/waqiti"
    op.authorization_endpoint: "https://auth.example.com/realms/waqiti/protocol/openid-connect/auth"
    op.token_endpoint: "https://auth.example.com/realms/waqiti/protocol/openid-connect/token"
    op.userinfo_endpoint: "https://auth.example.com/realms/waqiti/protocol/openid-connect/userinfo"
    op.jwkset_path: "https://auth.example.com/realms/waqiti/protocol/openid-connect/certs"
    rp.post_logout_redirect_uri: "https://logs.example.com/logout"
    claims.principal: email
    claims.groups: groups
    claims.name: name

# Role-based Access Control
xpack.security.authz.store.roles:
  waqiti_superuser:
    cluster: ["all"]
    indices:
      - names: ["*"]
        privileges: ["all"]
        allow_restricted_indices: true
  
  waqiti_admin:
    cluster: ["monitor", "manage_index_templates", "manage_ingest_pipelines"]
    indices:
      - names: ["waqiti-*", "audit-*", "security-*"]
        privileges: ["all"]
      - names: [".kibana*"]
        privileges: ["read", "write", "create", "delete", "create_index", "view_index_metadata"]
  
  waqiti_analyst:
    cluster: ["monitor"]
    indices:
      - names: ["waqiti-transactions-*", "waqiti-analytics-*", "waqiti-business-*"]
        privileges: ["read", "view_index_metadata"]
      - names: [".kibana*"]
        privileges: ["read"]
  
  waqiti_support:
    cluster: ["monitor"]
    indices:
      - names: ["waqiti-support-*", "waqiti-notifications-*", "waqiti-user-*"]
        privileges: ["read", "view_index_metadata"]
      - names: [".kibana*"]
        privileges: ["read"]
  
  waqiti_compliance:
    cluster: ["monitor"]
    indices:
      - names: ["waqiti-compliance-*", "audit-*", "waqiti-kyc-*", "waqiti-aml-*"]
        privileges: ["read", "view_index_metadata"]
      - names: [".kibana*"]
        privileges: ["read"]
  
  waqiti_developer:
    cluster: ["monitor"]
    indices:
      - names: ["waqiti-logs-*", "waqiti-metrics-*", "waqiti-traces-*"]
        privileges: ["read", "view_index_metadata"]
      - names: [".kibana*"]
        privileges: ["read"]

# Audit Logging
xpack.security.audit.enabled: true
xpack.security.audit.outputs: ["index", "logfile"]
xpack.security.audit.logfile.events.emit_request_body: false
xpack.security.audit.index.events.emit_request_body: false

# Include specific events for financial compliance
xpack.security.audit.logfile.events.include:
  - authentication_success
  - authentication_failed
  - access_granted
  - access_denied
  - tampered_request
  - connection_granted
  - connection_denied
  - anonymous_access_denied

# Anonymous access disabled for security
xpack.security.authc.anonymous.enabled: false

# API Key settings for service authentication
xpack.security.authc.api_key.enabled: true
xpack.security.authc.api_key.hashing.algorithm: pbkdf2_stretch

# Token service settings
xpack.security.authc.token.enabled: true
xpack.security.authc.token.timeout: 20m

# IP filtering for enhanced security
xpack.security.transport.filter.allow: ["10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16"]
xpack.security.transport.filter.deny: ["_all"]
xpack.security.http.filter.allow: ["10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16"]
xpack.security.http.filter.deny: ["_all"]

# Document and field level security
xpack.security.dls_fls.enabled: true

# Encryption at rest
xpack.security.encryption.at_rest.enabled: true

# Monitoring and telemetry
xpack.monitoring.enabled: true
xpack.monitoring.collection.enabled: true
xpack.monitoring.elasticsearch.collection.enabled: false

# Machine Learning (disabled for initial deployment)
xpack.ml.enabled: false
node.ml: false

# Watcher for alerting
xpack.watcher.enabled: true

# Graph exploration
xpack.graph.enabled: true

# SQL access
xpack.sql.enabled: true

# Index lifecycle management
xpack.ilm.enabled: true

# Rollup for historical data compression
xpack.rollup.enabled: true

# Cross-cluster replication
xpack.ccr.enabled: true

# Snapshot lifecycle management
xpack.slm.enabled: true

# Repository settings for backups
path.repo: ["/usr/share/elasticsearch/backup"]

# JVM heap settings (set via environment variables)
# -Xms2g -Xmx2g

# Garbage collection settings
## G1GC Configuration for better performance with large heaps
#-XX:+UseG1GC
#-XX:G1HeapRegionSize=32m
#-XX:+UseStringDeduplication

# Index settings for financial data
index.number_of_shards: 3
index.number_of_replicas: 1
index.refresh_interval: 30s

# Search settings
search.max_buckets: 65536
search.max_async_search_response_size: 10mb

# Circuit breaker settings
indices.breaker.total.limit: 70%
indices.breaker.request.limit: 40%
indices.breaker.fielddata.limit: 40%

# Thread pool settings
thread_pool.search.size: 13
thread_pool.search.queue_size: 1000
thread_pool.write.size: 8
thread_pool.write.queue_size: 200

# Recovery settings
cluster.routing.allocation.node_concurrent_recoveries: 4
indices.recovery.max_bytes_per_sec: 100mb

# Slow log settings for performance monitoring
index.search.slowlog.threshold.query.warn: 10s
index.search.slowlog.threshold.query.info: 5s
index.search.slowlog.threshold.query.debug: 2s
index.search.slowlog.threshold.query.trace: 500ms

index.search.slowlog.threshold.fetch.warn: 1s
index.search.slowlog.threshold.fetch.info: 800ms
index.search.slowlog.threshold.fetch.debug: 500ms
index.search.slowlog.threshold.fetch.trace: 200ms

index.indexing.slowlog.threshold.index.warn: 10s
index.indexing.slowlog.threshold.index.info: 5s
index.indexing.slowlog.threshold.index.debug: 2s
index.indexing.slowlog.threshold.index.trace: 500ms