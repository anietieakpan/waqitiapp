# Comprehensive Vulnerability Scanning Pipeline
# Multi-layer security scanning with automated remediation
# Integrates SAST, DAST, SCA, and infrastructure scanning

name: Vulnerability Scanning Pipeline

on:
  # Run on every push to main and pull requests
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  
  # Scheduled daily scans at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of scan to run'
        required: true
        default: 'full'
        type: choice
        options:
          - 'full'
          - 'sast'
          - 'dast'
          - 'sca'
          - 'infrastructure'
          - 'secrets'
      severity_threshold:
        description: 'Minimum severity to report'
        required: true
        default: 'MEDIUM'
        type: choice
        options:
          - 'LOW'
          - 'MEDIUM'
          - 'HIGH'
          - 'CRITICAL'

env:
  # Security scanning configuration
  SEVERITY_THRESHOLD: ${{ github.event.inputs.severity_threshold || 'MEDIUM' }}
  FAIL_ON_HIGH: true
  FAIL_ON_CRITICAL: true
  
  # Container registry
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  
  # Notification settings
  SLACK_WEBHOOK: ${{ secrets.SECURITY_SLACK_WEBHOOK }}
  JIRA_PROJECT: SEC

jobs:
  # Job 1: Static Application Security Testing (SAST)
  sast-scan:
    name: Static Analysis Security Testing
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'sast' || github.event.inputs.scan_type == '' }}
    
    permissions:
      contents: read
      security-events: write
      actions: read
    
    strategy:
      matrix:
        language: [ 'java', 'javascript', 'python' ]
        tool: [ 'codeql', 'sonarqube', 'semgrep' ]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # CodeQL Analysis
      - name: Initialize CodeQL
        if: matrix.tool == 'codeql'
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          config-file: ./.github/codeql/codeql-config.yml
      
      - name: Setup Java for CodeQL
        if: matrix.tool == 'codeql' && matrix.language == 'java'
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: temurin
      
      - name: Build for CodeQL
        if: matrix.tool == 'codeql'
        run: |
          if [ "${{ matrix.language }}" == "java" ]; then
            ./mvnw clean compile -DskipTests
          elif [ "${{ matrix.language }}" == "javascript" ]; then
            npm ci
            npm run build
          fi
      
      - name: Perform CodeQL Analysis
        if: matrix.tool == 'codeql'
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
      
      # SonarQube Analysis
      - name: SonarQube Scan
        if: matrix.tool == 'sonarqube'
        uses: sonarqube-quality-gate-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          scanMetadataReportFile: target/sonar/report-task.txt
      
      # Semgrep SAST
      - name: Semgrep SAST Scan
        if: matrix.tool == 'semgrep'
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/owasp-top-ten
            p/cwe-top-25
            p/spring-security
            p/jwt
            p/sql-injection
            p/xss
          generateSarif: "1"
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
      
      - name: Upload Semgrep SARIF
        if: matrix.tool == 'semgrep' && always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
      
      # Custom Security Rules
      - name: Run Custom Security Rules
        run: |
          echo "Running custom security pattern detection..."
          
          # Check for hardcoded secrets patterns
          grep -r -n -E "(password|secret|key|token)\s*=\s*['\"][^'\"]+['\"]" \
            --include="*.java" --include="*.js" --include="*.py" --include="*.yml" \
            --exclude-dir=target --exclude-dir=node_modules --exclude-dir=.git \
            . || echo "No hardcoded secrets found"
          
          # Check for SQL injection vulnerabilities
          grep -r -n -E "Statement.*execute.*\+|PreparedStatement.*setString.*\+|query.*\+.*request\." \
            --include="*.java" \
            --exclude-dir=target --exclude-dir=.git \
            . || echo "No obvious SQL injection patterns found"
          
          # Check for XSS vulnerabilities
          grep -r -n -E "innerHTML|outerHTML|document\.write|eval\(" \
            --include="*.js" --include="*.ts" \
            --exclude-dir=node_modules --exclude-dir=.git \
            . || echo "No obvious XSS patterns found"
      
      - name: Generate SAST Report
        run: |
          echo "# SAST Scan Report - ${{ matrix.tool }} (${{ matrix.language }})" > sast-report-${{ matrix.tool }}-${{ matrix.language }}.md
          echo "Generated on: $(date)" >> sast-report-${{ matrix.tool }}-${{ matrix.language }}.md
          echo "" >> sast-report-${{ matrix.tool }}-${{ matrix.language }}.md
          
          # Add scan results summary
          if [ -f "results.sarif" ]; then
            echo "## Results Summary" >> sast-report-${{ matrix.tool }}-${{ matrix.language }}.md
            jq '.runs[0].results | length' results.sarif >> sast-report-${{ matrix.tool }}-${{ matrix.language }}.md
          fi
      
      - name: Upload SAST Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sast-results-${{ matrix.tool }}-${{ matrix.language }}
          path: |
            *.sarif
            *-report-*.md
          retention-days: 30

  # Job 2: Software Composition Analysis (SCA)
  sca-scan:
    name: Software Composition Analysis
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'sca' || github.event.inputs.scan_type == '' }}
    
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Java dependency scanning
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: temurin
      
      - name: OWASP Dependency Check (Java)
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'Waqiti-Platform'
          path: '.'
          format: 'ALL'
          args: >
            --enableRetired
            --enableExperimental
            --cveValidForHours 4
            --failOnCVSS 7
            --exclude '**/target/**'
            --exclude '**/node_modules/**'
        env:
          JAVA_HOME: /opt/java/openjdk
      
      - name: Upload OWASP Dependency Check results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/dependency-check-report.sarif
      
      # Node.js dependency scanning
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: NPM Audit
        run: |
          find . -name "package.json" -not -path "./node_modules/*" | while read package; do
            dir=$(dirname "$package")
            echo "Auditing $dir..."
            cd "$dir"
            npm audit --audit-level=${{ env.SEVERITY_THRESHOLD }} --json > npm-audit-results.json || true
            cd - > /dev/null
          done
      
      - name: Snyk Security Scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=${{ env.SEVERITY_THRESHOLD }} --json-file-output=snyk-results.json
      
      # Python dependency scanning
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Safety Check (Python)
        run: |
          pip install safety
          find . -name "requirements*.txt" -not -path "./venv/*" | while read req; do
            echo "Checking $req..."
            safety check -r "$req" --json > safety-results.json || true
          done
      
      # Docker image scanning
      - name: Build Docker Images for Scanning
        run: |
          docker build -t waqiti/api-gateway:scan services/api-gateway/
          docker build -t waqiti/user-service:scan services/user-service/
          docker build -t waqiti/payment-service:scan services/payment-service/
      
      - name: Trivy Container Scanning
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'waqiti/api-gateway:scan'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: Generate SCA Report
        run: |
          echo "# Software Composition Analysis Report" > sca-report.md
          echo "Generated on: $(date)" >> sca-report.md
          echo "" >> sca-report.md
          
          # Summarize OWASP results
          if [ -f "reports/dependency-check-report.json" ]; then
            echo "## OWASP Dependency Check Results" >> sca-report.md
            jq '.dependencies | length' reports/dependency-check-report.json >> sca-report.md
          fi
          
          # Summarize NPM audit results
          if [ -f "npm-audit-results.json" ]; then
            echo "## NPM Audit Results" >> sca-report.md
            jq '.metadata.vulnerabilities' npm-audit-results.json >> sca-report.md
          fi
          
          # Summarize Snyk results
          if [ -f "snyk-results.json" ]; then
            echo "## Snyk Security Results" >> sca-report.md
            jq '.vulnerabilities | length' snyk-results.json >> sca-report.md
          fi
      
      - name: Upload SCA Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sca-results
          path: |
            reports/
            *-results.json
            *-report.md
            *.sarif
          retention-days: 30

  # Job 3: Dynamic Application Security Testing (DAST)
  dast-scan:
    name: Dynamic Application Security Testing
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'dast' || github.event.inputs.scan_type == '' }}
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: waqiti_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: temurin
      
      - name: Build and Start Application
        run: |
          # Build the application
          ./mvnw clean package -DskipTests
          
          # Start the application in background
          java -jar services/api-gateway/target/api-gateway-*.jar \
            --spring.profiles.active=test \
            --spring.datasource.url=jdbc:postgresql://localhost:5432/waqiti_test \
            --spring.datasource.username=postgres \
            --spring.datasource.password=testpassword &
          
          # Wait for application to start
          sleep 60
          
          # Health check
          curl -f http://localhost:8080/health || exit 1
      
      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:8080'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -d -T 60 -m 5'
      
      - name: OWASP ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.8.0
        with:
          target: 'http://localhost:8080'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -d -T 300'
      
      - name: Nuclei DAST Scan
        uses: projectdiscovery/nuclei-action@main
        with:
          target: 'http://localhost:8080'
          templates: |
            cves/
            exposures/
            fuzzing/
            misconfiguration/
            network/
            takeovers/
            technologies/
            vulnerabilities/
      
      - name: Custom API Security Tests
        run: |
          echo "Running custom API security tests..."
          
          # Test for common API vulnerabilities
          BASE_URL="http://localhost:8080"
          
          # Test authentication bypass
          echo "Testing authentication bypass..."
          curl -s -w "%{http_code}" -o /dev/null "$BASE_URL/api/admin/users" | grep -q "401\|403" || echo "VULNERABILITY: Admin endpoint accessible without auth"
          
          # Test for information disclosure
          echo "Testing information disclosure..."
          curl -s "$BASE_URL/actuator/env" | grep -q "password\|secret\|key" && echo "VULNERABILITY: Sensitive info disclosed"
          
          # Test rate limiting
          echo "Testing rate limiting..."
          for i in {1..100}; do
            curl -s -w "%{http_code}" -o /dev/null "$BASE_URL/api/auth/login"
          done | tail -1 | grep -q "429" && echo "Rate limiting working" || echo "WARNING: No rate limiting detected"
          
          # Test CORS configuration
          echo "Testing CORS configuration..."
          curl -s -H "Origin: http://malicious.com" -H "Access-Control-Request-Method: POST" \
            -H "Access-Control-Request-Headers: X-Requested-With" \
            -X OPTIONS "$BASE_URL/api/payments" | grep -q "Access-Control-Allow-Origin: http://malicious.com" && \
            echo "VULNERABILITY: Overly permissive CORS" || echo "CORS properly configured"
      
      - name: Generate DAST Report
        run: |
          echo "# Dynamic Application Security Testing Report" > dast-report.md
          echo "Generated on: $(date)" >> dast-report.md
          echo "" >> dast-report.md
          
          # ZAP results
          if [ -f "report_html.html" ]; then
            echo "## OWASP ZAP Results" >> dast-report.md
            echo "See attached HTML report" >> dast-report.md
          fi
          
          # Nuclei results
          if [ -f "nuclei-results.txt" ]; then
            echo "## Nuclei Scan Results" >> dast-report.md
            wc -l nuclei-results.txt >> dast-report.md
          fi
      
      - name: Upload DAST Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dast-results
          path: |
            report_html.html
            report_json.json
            nuclei-results.txt
            dast-report.md
          retention-days: 30

  # Job 4: Infrastructure Security Scanning
  infrastructure-scan:
    name: Infrastructure Security Scanning
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'infrastructure' || github.event.inputs.scan_type == '' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Terraform security scanning
      - name: Checkov Infrastructure Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: infrastructure/
          framework: terraform,kubernetes,dockerfile
          output_format: sarif
          output_file_path: checkov-results.sarif
        continue-on-error: true
      
      - name: Upload Checkov results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov-results.sarif
      
      # Kubernetes security scanning
      - name: Kubesec Scan
        run: |
          curl -sSX POST --data-binary @kubernetes/manifests/deployment.yml \
            "https://v2.kubesec.io/scan" > kubesec-results.json
      
      - name: Kube-bench Security Scan
        run: |
          docker run --rm -v "$(pwd)":/workspace aquasec/kube-bench:latest \
            --config-dir /workspace/kubernetes/security \
            --config /workspace/kubernetes/security/config.yaml \
            --json > kube-bench-results.json
      
      # Docker security scanning
      - name: Dockerfile Security Scan
        run: |
          find . -name "Dockerfile*" | while read dockerfile; do
            echo "Scanning $dockerfile..."
            docker run --rm -v "$(pwd):/workspace" \
              hadolint/hadolint:latest hadolint "/workspace/$dockerfile" \
              --format json > "hadolint-$(basename $dockerfile).json"
          done
      
      # AWS security scanning (if applicable)
      - name: AWS Config Rules Check
        if: contains(github.repository, 'aws')
        run: |
          # Simulate AWS security checks
          echo "Checking AWS security configurations..."
          
          # Check for public S3 buckets
          echo "Checking for public S3 bucket configurations..."
          find . -name "*.tf" -exec grep -l "public-read\|public-read-write" {} \; > aws-public-resources.txt
          
          # Check for overly permissive IAM policies
          echo "Checking IAM policy configurations..."
          find . -name "*.tf" -exec grep -l '"*"' {} \; > aws-wildcard-policies.txt
      
      - name: Generate Infrastructure Report
        run: |
          echo "# Infrastructure Security Scan Report" > infrastructure-report.md
          echo "Generated on: $(date)" >> infrastructure-report.md
          echo "" >> infrastructure-report.md
          
          # Checkov results
          if [ -f "checkov-results.sarif" ]; then
            echo "## Checkov Infrastructure Results" >> infrastructure-report.md
            jq '.runs[0].results | length' checkov-results.sarif >> infrastructure-report.md
          fi
          
          # Kubesec results
          if [ -f "kubesec-results.json" ]; then
            echo "## Kubesec Results" >> infrastructure-report.md
            jq '.score' kubesec-results.json >> infrastructure-report.md
          fi
      
      - name: Upload Infrastructure Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-results
          path: |
            *-results.json
            *-results.sarif
            infrastructure-report.md
            aws-*.txt
          retention-days: 30

  # Job 5: Secrets Scanning
  secrets-scan:
    name: Secrets and Sensitive Data Scanning
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'secrets' || github.event.inputs.scan_type == '' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: TruffleHog OSS Secrets Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified --json
      
      - name: GitLeaks Secrets Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE}}
      
      - name: Detect-secrets Scan
        run: |
          pip install detect-secrets
          detect-secrets scan --all-files --baseline .secrets.baseline > detect-secrets-results.json
          detect-secrets audit .secrets.baseline
      
      - name: Custom Secrets Pattern Detection
        run: |
          echo "# Custom Secrets Scan Results" > secrets-report.md
          echo "Generated on: $(date)" >> secrets-report.md
          echo "" >> secrets-report.md
          
          # Define patterns for different types of secrets
          declare -A patterns=(
            ["AWS_ACCESS_KEY"]="AKIA[0-9A-Z]{16}"
            ["AWS_SECRET_KEY"]="[0-9a-zA-Z/+=]{40}"
            ["JWT_TOKEN"]="eyJ[A-Za-z0-9-_=]+\.[A-Za-z0-9-_=]+\.?[A-Za-z0-9-_.+/=]*"
            ["API_KEY"]="[Aa][Pp][Ii]_?[Kk][Ee][Yy].*['\"][0-9a-zA-Z]{32,45}['\"]"
            ["PASSWORD"]="[Pp][Aa][Ss][Ss][Ww][Oo][Rr][Dd].*['\"][^'\"]{8,}['\"]"
            ["PRIVATE_KEY"]="-----BEGIN.*PRIVATE KEY-----"
            ["DATABASE_URL"]="(mysql|postgresql|mongodb)://[^\\s]+"
          )
          
          for pattern_name in "${!patterns[@]}"; do
            pattern="${patterns[$pattern_name]}"
            echo "## Scanning for $pattern_name" >> secrets-report.md
            
            matches=$(grep -r -E "$pattern" \
              --exclude-dir=.git \
              --exclude-dir=node_modules \
              --exclude-dir=target \
              --exclude="*.log" \
              --exclude="*.sarif" \
              --exclude="secrets-report.md" \
              . || true)
            
            if [ ! -z "$matches" ]; then
              echo "FOUND $pattern_name patterns:" >> secrets-report.md
              echo "$matches" >> secrets-report.md
            else
              echo "No $pattern_name patterns found" >> secrets-report.md
            fi
            echo "" >> secrets-report.md
          done
      
      - name: Upload Secrets Scan Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: secrets-results
          path: |
            detect-secrets-results.json
            secrets-report.md
            .secrets.baseline
          retention-days: 30

  # Job 6: Vulnerability Report Consolidation
  consolidate-results:
    name: Consolidate Security Results
    runs-on: ubuntu-latest
    needs: [sast-scan, sca-scan, dast-scan, infrastructure-scan, secrets-scan]
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: scan-results/
      
      - name: Consolidate Security Report
        run: |
          echo "# Comprehensive Security Scan Report" > security-report.md
          echo "Generated on: $(date)" >> security-report.md
          echo "Repository: ${{ github.repository }}" >> security-report.md
          echo "Commit: ${{ github.sha }}" >> security-report.md
          echo "" >> security-report.md
          
          # Executive Summary
          echo "## Executive Summary" >> security-report.md
          echo "" >> security-report.md
          
          total_critical=0
          total_high=0
          total_medium=0
          total_low=0
          
          # Count vulnerabilities from SARIF files
          find scan-results/ -name "*.sarif" | while read sarif_file; do
            if [ -f "$sarif_file" ]; then
              critical=$(jq '[.runs[].results[] | select(.level == "error")] | length' "$sarif_file" 2>/dev/null || echo "0")
              high=$(jq '[.runs[].results[] | select(.level == "warning")] | length' "$sarif_file" 2>/dev/null || echo "0")
              medium=$(jq '[.runs[].results[] | select(.level == "note")] | length' "$sarif_file" 2>/dev/null || echo "0")
              
              echo "File: $(basename $sarif_file)" >> security-report.md
              echo "- Critical: $critical" >> security-report.md
              echo "- High: $high" >> security-report.md
              echo "- Medium: $medium" >> security-report.md
              echo "" >> security-report.md
            fi
          done
          
          # Add detailed findings from each scan type
          echo "## SAST Results" >> security-report.md
          find scan-results/sast-results-* -name "*-report-*.md" -exec cat {} \; >> security-report.md 2>/dev/null || echo "No SAST results found"
          echo "" >> security-report.md
          
          echo "## SCA Results" >> security-report.md
          cat scan-results/sca-results/sca-report.md >> security-report.md 2>/dev/null || echo "No SCA results found"
          echo "" >> security-report.md
          
          echo "## DAST Results" >> security-report.md
          cat scan-results/dast-results/dast-report.md >> security-report.md 2>/dev/null || echo "No DAST results found"
          echo "" >> security-report.md
          
          echo "## Infrastructure Results" >> security-report.md
          cat scan-results/infrastructure-results/infrastructure-report.md >> security-report.md 2>/dev/null || echo "No Infrastructure results found"
          echo "" >> security-report.md
          
          echo "## Secrets Scan Results" >> security-report.md
          cat scan-results/secrets-results/secrets-report.md >> security-report.md 2>/dev/null || echo "No Secrets results found"
          echo "" >> security-report.md
          
          # Recommendations
          echo "## Recommendations" >> security-report.md
          echo "" >> security-report.md
          echo "1. Review and remediate all CRITICAL and HIGH severity vulnerabilities" >> security-report.md
          echo "2. Update dependencies with known vulnerabilities" >> security-report.md
          echo "3. Implement additional security controls based on findings" >> security-report.md
          echo "4. Schedule regular security scans and penetration testing" >> security-report.md
          echo "5. Enhance developer security training" >> security-report.md
      
      - name: Check Failure Conditions
        run: |
          # Count critical and high severity issues
          critical_count=0
          high_count=0
          
          find scan-results/ -name "*.sarif" | while read sarif_file; do
            if [ -f "$sarif_file" ]; then
              critical=$(jq '[.runs[].results[] | select(.level == "error")] | length' "$sarif_file" 2>/dev/null || echo "0")
              high=$(jq '[.runs[].results[] | select(.level == "warning")] | length' "$sarif_file" 2>/dev/null || echo "0")
              
              critical_count=$((critical_count + critical))
              high_count=$((high_count + high))
            fi
          done
          
          echo "Critical vulnerabilities found: $critical_count"
          echo "High vulnerabilities found: $high_count"
          
          # Fail the build if critical issues found and FAIL_ON_CRITICAL is true
          if [ "${{ env.FAIL_ON_CRITICAL }}" = "true" ] && [ $critical_count -gt 0 ]; then
            echo "Build failed due to critical security vulnerabilities"
            exit 1
          fi
          
          # Fail the build if high issues found and FAIL_ON_HIGH is true
          if [ "${{ env.FAIL_ON_HIGH }}" = "true" ] && [ $high_count -gt 0 ]; then
            echo "Build failed due to high severity security vulnerabilities"
            exit 1
          fi
      
      - name: Create Security Issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('security-report.md', 'utf8');
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Security Vulnerabilities Found - ${new Date().toISOString().split('T')[0]}`,
              body: report,
              labels: ['security', 'critical', 'vulnerability']
            });
      
      - name: Notify Security Team
        if: always()
        run: |
          if [ ! -z "${{ env.SLACK_WEBHOOK }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"Security scan completed for ${{ github.repository }}. Check the results at ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
              ${{ env.SLACK_WEBHOOK }}
          fi
      
      - name: Upload Consolidated Report
        uses: actions/upload-artifact@v4
        with:
          name: consolidated-security-report
          path: |
            security-report.md
            scan-results/
          retention-days: 90

  # Job 7: Auto-remediation (if enabled)
  auto-remediation:
    name: Automated Vulnerability Remediation
    runs-on: ubuntu-latest
    needs: [consolidate-results]
    if: github.event.inputs.scan_type == 'full' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Download Security Results
        uses: actions/download-artifact@v4
        with:
          name: consolidated-security-report
          path: security-results/
      
      - name: Auto-fix Dependencies
        run: |
          echo "Attempting automated dependency fixes..."
          
          # Java dependencies
          if [ -f "pom.xml" ]; then
            echo "Updating Java dependencies..."
            ./mvnw versions:use-latest-versions -DallowSnapshots=false
            ./mvnw versions:use-latest-releases
          fi
          
          # Node.js dependencies
          find . -name "package.json" -not -path "./node_modules/*" | while read package; do
            dir=$(dirname "$package")
            echo "Updating Node.js dependencies in $dir..."
            cd "$dir"
            npm audit fix --force 2>/dev/null || true
            cd - > /dev/null
          done
          
          # Python dependencies
          find . -name "requirements*.txt" | while read req; do
            echo "Checking Python dependencies in $req..."
            # This would need more sophisticated logic in practice
            pip-compile --upgrade "$req" 2>/dev/null || true
          done
      
      - name: Create Pull Request for Fixes
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "security: automated vulnerability fixes"
          title: "Automated Security Fixes"
          body: |
            This PR contains automated fixes for security vulnerabilities found during scanning.
            
            Please review the changes carefully before merging.
            
            Generated by GitHub Actions on $(date)
          branch: security/automated-fixes
          delete-branch: true