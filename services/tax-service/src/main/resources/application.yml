server:
  port: 8085

spring:
  application:
    name: tax-service
  
  datasource:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:waqiti_tax_db}
    username: ${DB_USERNAME:waqiti_tax}
    password: ${DB_PASSWORD:}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      leak-detection-threshold: 60000

  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
        use_sql_comments: true
        jdbc:
          batch_size: 50
          order_inserts: true
          order_updates: true
        cache:
          use_second_level_cache: true
          use_query_cache: true
          region:
            factory_class: org.hibernate.cache.jcache.JCacheRegionFactory

  flyway:
    enabled: true
    baseline-on-migrate: true
    locations: classpath:db/migration

  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 20
          max-idle: 8
          min-idle: 2

  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:kafka:9092}}
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
    consumer:
      group-id: tax-service
      enable-auto-commit: false  # Manual acknowledgment for DLQ support
      max-poll-records: 50  # Batch size control
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: com.waqiti.*

  cloud:
    openfeign:
      client:
        config:
          default:
            connect-timeout: 5000
            read-timeout: 10000

eureka:
  client:
    service-url:
      defaultZone: ${EUREKA_URL:${EUREKA_SERVER_URL:https://discovery-service:8761/eureka}}
  instance:
    prefer-ip-address: true
    lease-renewal-interval-in-seconds: 30
    lease-expiration-duration-in-seconds: 90

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: when-authorized
  metrics:
    export:
      prometheus:
        enabled: true

# Tax Service Specific Configuration
tax:
  filing:
    free:
      income-limit: 73000
    premium:
      fee: 0
    e-filing:
      enabled: true
    state-filing:
      enabled: true
      
  irs:
    integration:
      enabled: ${IRS_INTEGRATION_ENABLED:false}
      base-url: ${IRS_API_URL:https://api.irs.gov}
      api-key: ${IRS_API_KEY:}
      timeout: 30000
      
  encryption:
    key: ${TAX_ENCRYPTION_KEY}
    algorithm: AES/GCM/NoPadding
    
  document:
    storage:
      path: ${TAX_DOCUMENT_STORAGE:/var/tax-documents}
      max-file-size: 10MB
      allowed-types: pdf,jpg,jpeg,png
      
  optimization:
    engine:
      enabled: true
      confidence-threshold: 0.8
      
  crypto:
    tax:
      cost-basis-method: FIFO
      include-staking-rewards: true
      include-mining-income: true
      
  notifications:
    enabled: true
    channels: email,sms,push
    
  audit:
    enabled: true
    retention-days: 2555 # 7 years for tax records
# Keycloak Configuration
keycloak:
  enabled: true
  realm: waqiti-fintech
  auth-server-url: ${KEYCLOAK_AUTH_SERVER_URL:https://localhost:8080}
  ssl-required: external
  resource: tax-service
  bearer-only: true
  use-resource-role-mappings: true
  cors: true
  cors-allowed-methods: GET,POST,PUT,DELETE,OPTIONS
  cors-allowed-headers: Authorization,Content-Type,X-Requested-With
  cors-max-age: 3600
  public-client: false
  credentials:
    secret: ${KEYCLOAK_CLIENT_SECRET:}

# Spring Security OAuth2 Configuration
spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${KEYCLOAK_AUTH_SERVER_URL:https://localhost:8080}/realms/waqiti
          jwk-set-uri: ${KEYCLOAK_AUTH_SERVER_URL:https://localhost:8080}/realms/waqiti/protocol/openid-connect/certs
      client:
        registration:
          keycloak:
            client-id: tax-service
            client-secret: ${KEYCLOAK_CLIENT_SECRET:}
            authorization-grant-type: client_credentials
            scope: openid,profile,email,tax
        provider:
          keycloak:
            issuer-uri: ${KEYCLOAK_AUTH_SERVER_URL:https://localhost:8080}/realms/waqiti
            token-uri: ${KEYCLOAK_AUTH_SERVER_URL:https://localhost:8080}/realms/waqiti/protocol/openid-connect/token
            authorization-uri: ${KEYCLOAK_AUTH_SERVER_URL:https://localhost:8080}/realms/waqiti/protocol/openid-connect/auth
            userinfo-uri: ${KEYCLOAK_AUTH_SERVER_URL:https://localhost:8080}/realms/waqiti/protocol/openid-connect/userinfo
            jwk-set-uri: ${KEYCLOAK_AUTH_SERVER_URL:https://localhost:8080}/realms/waqiti/protocol/openid-connect/certs

# Service-to-Service Authentication
service:
  auth:
    enabled: true
    client-id: tax-service
    client-secret: ${KEYCLOAK_CLIENT_SECRET:}
    
# Security Configuration
security:
  encryption:
    tax-data-key: ${TAX_DATA_ENCRYPTION_KEY}

# Logging Configuration
logging:
  level:
    com.waqiti.tax: INFO
    org.hibernate.SQL: WARN
    org.hibernate.type.descriptor.sql.BasicBinder: WARN
  pattern:
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{traceId:-},%X{spanId:-}] %logger{36} - %msg%n"
    console: "%d{HH:mm:ss.SSS} [%thread] %-5level [%X{traceId:-},%X{spanId:-}] %logger{36} - %msg%n"

# Distributed Tracing
spring.sleuth:
  zipkin:
    base-url: ${ZIPKIN_URL:http://localhost:9411}
  sampler:
    probability: 0.1
