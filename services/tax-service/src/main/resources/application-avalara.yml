# Avalara AvaTax Configuration
# Production Tax Calculation Service

avalara:
  api:
    url: ${AVALARA_API_URL:https://rest.avalara.com}
    timeout: 10000  # 10 seconds
  account:
    id: ${AVALARA_ACCOUNT_ID}
    # CRITICAL SECURITY: Store license key in secrets manager (AWS Secrets Manager, HashiCorp Vault)
    # Never commit actual credentials to source control
  license:
    key: ${AVALARA_LICENSE_KEY}
  company:
    code: ${AVALARA_COMPANY_CODE:DEFAULT}
  environment: ${AVALARA_ENVIRONMENT:sandbox}  # sandbox or production

# Tax Calculation Configuration
tax:
  avalara:
    enabled: true
    # Use Avalara for amounts >= $1.00 (save API calls for small transactions)
    minimum-amount: 1.00

  validation:
    # Cross-check Avalara against internal rules for high-value transactions
    cross-check:
      enabled: true
      threshold: 10000.00  # Cross-validate transactions >= $10,000
    # Tolerance for discrepancy alerts (10 cents)
    tolerance: 0.10

  # Fallback behavior when Avalara is unavailable
  fallback:
    enabled: true
    default-rate: 0.08  # 8% emergency fallback rate

  # Transaction commitment settings
  commitment:
    auto-commit: false  # Manually commit after payment confirmation
    batch-commit:
      enabled: true
      schedule: "0 0 * * * *"  # Every hour

# Resilience4j Configuration for Avalara
resilience4j:
  circuitbreaker:
    instances:
      avalara:
        register-health-indicator: true
        sliding-window-size: 10
        minimum-number-of-calls: 5
        permitted-number-of-calls-in-half-open-state: 3
        automatic-transition-from-open-to-half-open-enabled: true
        wait-duration-in-open-state: 60s
        failure-rate-threshold: 50
        slow-call-duration-threshold: 5s
        slow-call-rate-threshold: 50
        # Error handling
        record-exceptions:
          - com.waqiti.tax.client.AvalaraTaxClient$AvalaraTaxException
          - org.springframework.web.client.HttpServerErrorException
        ignore-exceptions:
          - org.springframework.web.client.HttpClientErrorException$BadRequest

  retry:
    instances:
      avalara:
        max-attempts: 3
        wait-duration: 1000  # 1 second
        exponential-backoff-multiplier: 2
        retry-exceptions:
          - org.springframework.web.client.ResourceAccessException
          - org.springframework.web.client.HttpServerErrorException

  timelimiter:
    instances:
      avalara:
        timeout-duration: 10s

# Kafka Configuration for Tax Events
spring:
  kafka:
    producer:
      bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092}
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      properties:
        "[spring.json.add.type.headers]": false

    # Tax event topics
    template:
      default-topic: tax-events

# Logging Configuration
logging:
  level:
    com.waqiti.tax.client.AvalaraTaxClient: INFO
    com.waqiti.tax.service.ProductionTaxCalculationService: INFO
    # Debug Avalara API calls in development
    org.springframework.web.client.RestTemplate: ${AVALARA_DEBUG_LOGGING:WARN}

# Monitoring and Metrics
management:
  metrics:
    tags:
      service: tax-service
      integration: avalara
    export:
      prometheus:
        enabled: true

  health:
    circuitbreakers:
      enabled: true

  endpoints:
    web:
      exposure:
        include: health,metrics,prometheus,circuitbreakers

# Cache Configuration for Tax Rates
spring.cache:
  type: redis
  redis:
    time-to-live: 300000  # 5 minutes
  cache-names:
    - tax-rules
    - tax-rates
    - address-validation

# Database Configuration for Tax Transactions
spring.jpa:
  properties:
    hibernate:
      # Use batch inserts for tax transactions
      jdbc:
        batch_size: 20
      order_inserts: true
      order_updates: true

# Scheduled Jobs Configuration
spring.task:
  scheduling:
    pool:
      size: 5
    thread-name-prefix: tax-scheduled-

---
# Development/Sandbox Profile
spring:
  config:
    activate:
      on-profile: sandbox

avalara:
  api:
    url: https://sandbox-rest.avalara.com
  environment: sandbox

tax:
  avalara:
    enabled: true
  validation:
    cross-check:
      enabled: true

logging:
  level:
    com.waqiti.tax: DEBUG
    org.springframework.web.client.RestTemplate: DEBUG

---
# Production Profile
spring:
  config:
    activate:
      on-profile: production

avalara:
  api:
    url: https://rest.avalara.com
  environment: production

tax:
  avalara:
    enabled: true
  validation:
    cross-check:
      enabled: true
      # Higher threshold for production (only cross-check very large transactions)
      threshold: 50000.00

logging:
  level:
    com.waqiti.tax: INFO
    org.springframework.web.client.RestTemplate: WARN

# Production-specific security
management:
  endpoints:
    web:
      exposure:
        # Restrict endpoints in production
        include: health,metrics,prometheus
