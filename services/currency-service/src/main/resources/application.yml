server:
  port: 8060
  servlet:
    context-path: /api/v1

spring:
  application:
    name: currency-service
  
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}
  
  datasource:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:waqiti_currency}?ssl=${DB_SSL_ENABLED:true}&stringtype=unspecified
    username: ${DB_USERNAME:waqiti_user}
    password: ${vault.database.password:${VAULT_CURRENCY_SERVICE_DB_PASSWORD}}
    driver-class-name: org.postgresql.Driver
    
  jpa:
    hibernate:
      ddl-auto: ${DDL_AUTO:validate}
      naming:
        physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
    show-sql: ${SHOW_SQL:false}
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
        use_sql_comments: true
        jdbc:
          time_zone: UTC

  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:kafka:9092}}
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      properties:
        spring.json.add.type.headers: false
    consumer:
      group-id: currency-service
      enable-auto-commit: false  # Manual acknowledgment for DLQ support
      max-poll-records: 50  # Batch size control
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "com.waqiti.currency.dto,com.example.common.events"

  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 20
          max-idle: 10
          min-idle: 2

  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${KEYCLOAK_ISSUER_URI:https://localhost:8080/realms/waqiti}
          jwk-set-uri: ${KEYCLOAK_JWK_SET_URI:https://auth.example.com/realms/waqiti/protocol/openid-connect/certs}

  cache:
    type: redis
    redis:
      time-to-live: 300000 # 5 minutes

eureka:
  client:
    service-url:
      defaultZone: ${EUREKA_SERVER_URL:${EUREKA_SERVER_URL:https://discovery-service:8761/eureka}/}
    fetch-registry: true
    register-with-eureka: true
  instance:
    prefer-ip-address: true
    lease-renewal-interval-in-seconds: 10
    lease-expiration-duration-in-seconds: 30

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,caches
  endpoint:
    health:
      show-details: when-authorized
  metrics:
    export:
      prometheus:
        enabled: true

logging:
  level:
    com.waqiti.currency: ${LOG_LEVEL:INFO}
    org.springframework.security: ${SECURITY_LOG_LEVEL:WARN}
    org.hibernate.SQL: ${SQL_LOG_LEVEL:WARN}
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level [%logger{36}] - %msg%n"

waqiti:
  currency:
    # Exchange rate providers configuration
    providers:
      primary: ${PRIMARY_RATE_PROVIDER:fixer}
      secondary: ${SECONDARY_RATE_PROVIDER:exchangerate}
      fallback: ${FALLBACK_RATE_PROVIDER:ecb}
      
      fixer:
        api-key: ${FIXER_API_KEY:your-fixer-api-key}
        base-url: ${FIXER_BASE_URL:http://data.fixer.io/api}
        timeout: ${FIXER_TIMEOUT:5000}
        
      exchangerate:
        api-key: ${EXCHANGERATE_API_KEY:your-exchangerate-api-key}
        base-url: ${EXCHANGERATE_BASE_URL:https://v6.exchangerate-api.com/v6}
        timeout: ${EXCHANGERATE_TIMEOUT:5000}
        
      ecb:
        base-url: ${ECB_BASE_URL:https://www.ecb.europa.eu/stats/eurofxref}
        timeout: ${ECB_TIMEOUT:10000}
        
    # Rate refresh configuration
    refresh:
      enabled: ${RATE_REFRESH_ENABLED:true}
      interval: ${RATE_REFRESH_INTERVAL:300000} # 5 minutes
      initial-delay: ${RATE_REFRESH_INITIAL_DELAY:60000} # 1 minute
      max-age: ${MAX_RATE_AGE:600000} # 10 minutes
      
    # Cache configuration
    cache:
      enabled: ${CACHE_ENABLED:true}
      ttl: ${CACHE_TTL:300} # 5 minutes
      max-size: ${CACHE_MAX_SIZE:1000}
      
    # Supported currencies
    supported:
      base: ${BASE_CURRENCY:USD}
      currencies: >
        USD,EUR,GBP,JPY,CHF,CAD,AUD,NZD,SEK,NOK,DKK,PLN,CZK,HUF,RON,BGN,HRK,
        RUB,CNY,INR,KRW,SGD,HKD,THB,MYR,IDR,PHP,VND,TRY,ZAR,BRL,MXN,ARS,CLP,
        COP,PEN,UYU,BOB,PYG,VES,GYD,SRD,XCD,JMD,BBD,BSD,BZD,KYD,XPF,FJD,PGK,
        SBD,TOP,VUV,WST,NGN,GHS,XOF,XAF,EGP,MAD,TND,DZD,LYD,ETB,KES,UGX,TZS,
        RWF,MWK,ZMW,BWP,NAD,SZL,LSL,MZN,AOA,CVE,GMD,GNF,LRD,SLL,STN,AED,BHD,
        ILS,IRR,IQD,JOD,KWD,LBP,OMR,QAR,SAR,SYP,YER,AFN,PKR,LKR,BDT,BTN,MVR,
        NPR,MMK,LAK,KHR,BND,TWD,MOP,KPW,MNT,UZS,KZT,KGS,TJS,TMT,AZN,AMD,GEL,
        BYN,MDL,UAH,RSD,MKD,ALL,BAM,CUC,CUP,DOP,GTQ,HNL,NIO,PAB,HTG,AWG,ANG,
        SVC,CRC,FKP,GIP,SHP,GGP,JEP,IMP,TVD,NRU,AUD
        
    # Conversion limits
    limits:
      max-amount: ${MAX_CONVERSION_AMOUNT:1000000.00}
      daily-limit: ${DAILY_CONVERSION_LIMIT:10000000.00}
      rate-change-threshold: ${RATE_CHANGE_THRESHOLD:0.05} # 5%
      
    # Historical data
    historical:
      enabled: ${HISTORICAL_DATA_ENABLED:true}
      retention-days: ${HISTORICAL_RETENTION_DAYS:365}
      batch-size: ${HISTORICAL_BATCH_SIZE:100}
      
    # Multi-currency account support
    accounts:
      enabled: ${MULTI_CURRENCY_ACCOUNTS_ENABLED:true}
      max-currencies-per-account: ${MAX_CURRENCIES_PER_ACCOUNT:10}
      auto-conversion-enabled: ${AUTO_CONVERSION_ENABLED:true}
      default-conversion-threshold: ${DEFAULT_CONVERSION_THRESHOLD:0.01}
      
    # Compliance and regulations
    compliance:
      reporting-enabled: ${COMPLIANCE_REPORTING_ENABLED:true}
      suspicious-transaction-threshold: ${SUSPICIOUS_THRESHOLD:10000.00}
      large-transaction-threshold: ${LARGE_TRANSACTION_THRESHOLD:50000.00}
      
    # Real-time rates
    realtime:
      enabled: ${REALTIME_RATES_ENABLED:true}
      websocket-enabled: ${WEBSOCKET_ENABLED:true}
      rate-change-notification-threshold: ${RATE_CHANGE_NOTIFICATION:0.02} # 2%
      
    # Cross-border transfers
    transfers:
      enabled: ${CROSS_BORDER_TRANSFERS_ENABLED:true}
      max-transfer-amount: ${MAX_TRANSFER_AMOUNT:100000.00}
      correspondent-banks-enabled: ${CORRESPONDENT_BANKS_ENABLED:true}

resilience4j:
  circuitbreaker:
    instances:
      exchange-rate-api:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 30s
        permitted-number-of-calls-in-half-open-state: 3
      currency-conversion:
        sliding-window-size: 20
        failure-rate-threshold: 40
        wait-duration-in-open-state: 20s
        
  retry:
    instances:
      rate-fetch:
        max-attempts: 3
        wait-duration: 2s
        exponential-backoff-multiplier: 2
        retry-exceptions:
          - java.net.SocketTimeoutException
          - java.io.IOException
          
  ratelimiter:
    instances:
      conversion-api:
        limit-for-period: 100
        limit-refresh-period: 60s
        timeout-duration: 5s
      rate-api:
        limit-for-period: 1000
        limit-refresh-period: 60s
        timeout-duration: 2s

---
spring:
  config:
    activate:
      on-profile: test
  datasource:
    url: jdbc:h2:mem:testdb
    driver-class-name: org.h2.Driver
    username: sa
    password: 
  jpa:
    hibernate:
      ddl-auto: create-drop
    database-platform: org.hibernate.dialect.H2Dialect

waqiti:
  currency:
    providers:
      primary: mock
    refresh:
      enabled: false
    cache:
      enabled: false

---
spring:
  config:
    activate:
      on-profile: prod
  
  datasource:
    hikari:
      maximum-pool-size: 25
      minimum-idle: 5
      connection-timeout: 20000
      idle-timeout: 300000
      max-lifetime: 1200000
      
logging:
  level:
    com.waqiti.currency: INFO
    org.springframework.security: WARN
    root: WARN
  file:
    name: /var/log/waqiti/currency-service.log
  logback:
    rollingpolicy:
      max-file-size: 100MB
      max-history: 30

waqiti:
  currency:
    refresh:
      interval: 60000 # 1 minute in production
    cache:
      ttl: 60 # 1 minute in production
    limits:
      max-amount: 10000000.00
      daily-limit: 100000000.00
