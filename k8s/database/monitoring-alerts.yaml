apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: database-monitoring-alerts
  namespace: database
  labels:
    app: database-monitoring
    component: alerting
spec:
  groups:
  - name: postgresql-alerts
    rules:
    - alert: PostgreSQLDown
      expr: pg_up == 0
      for: 1m
      labels:
        severity: critical
        service: postgresql
      annotations:
        summary: "PostgreSQL instance is down"
        description: "PostgreSQL instance {{ $labels.instance }} has been down for more than 1 minute"
        runbook_url: "https://runbook.example.com/database/postgresql-down"
        
    - alert: PostgreSQLReplicationLag
      expr: pg_replication_lag_seconds > 30
      for: 2m
      labels:
        severity: warning
        service: postgresql
      annotations:
        summary: "PostgreSQL replication lag is high"
        description: "PostgreSQL replica {{ $labels.instance }} is lagging by {{ $value }} seconds"
        runbook_url: "https://runbook.example.com/database/replication-lag"
        
    - alert: PostgreSQLConnectionsHigh
      expr: pg_stat_database_numbackends / pg_settings_max_connections > 0.8
      for: 5m
      labels:
        severity: warning
        service: postgresql
      annotations:
        summary: "PostgreSQL connection usage is high"
        description: "PostgreSQL instance {{ $labels.instance }} is using {{ $value | humanizePercentage }} of available connections"
        
    - alert: PostgreSQLDiskSpaceLow
      expr: (node_filesystem_size_bytes{mountpoint="/var/lib/postgresql/data"} - node_filesystem_free_bytes{mountpoint="/var/lib/postgresql/data"}) / node_filesystem_size_bytes{mountpoint="/var/lib/postgresql/data"} > 0.85
      for: 5m
      labels:
        severity: critical
        service: postgresql
      annotations:
        summary: "PostgreSQL disk space is low"
        description: "PostgreSQL data directory on {{ $labels.instance }} is {{ $value | humanizePercentage }} full"
        
    - alert: PostgreSQLSlowQueries
      expr: rate(pg_stat_database_tup_returned[5m]) / rate(pg_stat_database_tup_fetched[5m]) < 0.1
      for: 10m
      labels:
        severity: warning
        service: postgresql
      annotations:
        summary: "PostgreSQL has slow queries"
        description: "PostgreSQL query efficiency on {{ $labels.instance }} is low: {{ $value | humanizePercentage }}"
        
    - alert: PostgreSQLBackupFailed
      expr: time() - pg_last_backup_timestamp > 86400  # 24 hours
      for: 1m
      labels:
        severity: critical
        service: postgresql-backup
      annotations:
        summary: "PostgreSQL backup is overdue"
        description: "PostgreSQL backup on {{ $labels.instance }} has not completed in the last 24 hours"
        runbook_url: "https://runbook.example.com/database/backup-failure"
        
  - name: redis-alerts
    rules:
    - alert: RedisDown
      expr: redis_up == 0
      for: 1m
      labels:
        severity: critical
        service: redis
      annotations:
        summary: "Redis instance is down"
        description: "Redis instance {{ $labels.instance }} has been down for more than 1 minute"
        runbook_url: "https://runbook.example.com/database/redis-down"
        
    - alert: RedisClusterDown
      expr: redis_cluster_state != 1
      for: 2m
      labels:
        severity: critical
        service: redis-cluster
      annotations:
        summary: "Redis cluster is not healthy"
        description: "Redis cluster {{ $labels.cluster }} is in unhealthy state"
        
    - alert: RedisMemoryUsageHigh
      expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.9
      for: 5m
      labels:
        severity: warning
        service: redis
      annotations:
        summary: "Redis memory usage is high"
        description: "Redis instance {{ $labels.instance }} memory usage is {{ $value | humanizePercentage }}"
        
    - alert: RedisConnectionsHigh
      expr: redis_connected_clients / redis_config_maxclients > 0.8
      for: 5m
      labels:
        severity: warning
        service: redis
      annotations:
        summary: "Redis connection usage is high"
        description: "Redis instance {{ $labels.instance }} is using {{ $value | humanizePercentage }} of max connections"
        
    - alert: RedisSlowQueries
      expr: redis_slowlog_length > 10
      for: 2m
      labels:
        severity: warning
        service: redis
      annotations:
        summary: "Redis has slow queries"
        description: "Redis instance {{ $labels.instance }} has {{ $value }} slow queries in log"
        
    - alert: RedisRejectedConnections
      expr: rate(redis_rejected_connections_total[5m]) > 0
      for: 1m
      labels:
        severity: critical
        service: redis
      annotations:
        summary: "Redis is rejecting connections"
        description: "Redis instance {{ $labels.instance }} rejected {{ $value }} connections/sec"
        
  - name: backup-alerts
    rules:
    - alert: BackupJobFailed
      expr: kube_job_status_failed > 0
      for: 1m
      labels:
        severity: critical
        service: backup
      annotations:
        summary: "Backup job failed"
        description: "Backup job {{ $labels.job_name }} in namespace {{ $labels.namespace }} has failed"
        runbook_url: "https://runbook.example.com/database/backup-job-failed"
        
    - alert: BackupDurationTooLong
      expr: time() - kube_job_status_start_time{job_name=~".*backup.*"} > 7200  # 2 hours
      for: 5m
      labels:
        severity: warning
        service: backup
      annotations:
        summary: "Backup job taking too long"
        description: "Backup job {{ $labels.job_name }} has been running for more than 2 hours"
        
    - alert: BackupStorageSpaceLow
      expr: s3_bucket_size_bytes{bucket="waqiti-postgres-backups"} / s3_bucket_quota_bytes{bucket="waqiti-postgres-backups"} > 0.85
      for: 5m
      labels:
        severity: warning
        service: backup-storage
      annotations:
        summary: "Backup storage space is low"
        description: "S3 backup bucket is {{ $value | humanizePercentage }} full"
        
  - name: database-security-alerts
    rules:
    - alert: DatabaseUnauthorizedAccess
      expr: increase(pg_stat_database_xact_rollback[5m]) / increase(pg_stat_database_xact_commit[5m]) > 0.1
      for: 2m
      labels:
        severity: warning
        service: postgresql-security
      annotations:
        summary: "High database transaction rollback rate"
        description: "PostgreSQL on {{ $labels.instance }} has {{ $value | humanizePercentage }} rollback rate - possible unauthorized access attempts"
        
    - alert: DatabaseConnectionSpike
      expr: rate(pg_stat_database_numbackends[5m]) > 10
      for: 1m
      labels:
        severity: warning
        service: postgresql-security
      annotations:
        summary: "Database connection spike detected"
        description: "PostgreSQL on {{ $labels.instance }} has unusual connection spike: {{ $value }} connections/sec"
        
    - alert: RedisCommandSpike
      expr: rate(redis_commands_total[5m]) > 1000
      for: 1m
      labels:
        severity: warning
        service: redis-security
      annotations:
        summary: "Redis command spike detected"
        description: "Redis on {{ $labels.instance }} has unusual command spike: {{ $value }} commands/sec"
---
apiVersion: v1
kind: ServiceMonitor
metadata:
  name: postgresql-exporter
  namespace: database
  labels:
    app: postgresql-exporter
spec:
  selector:
    matchLabels:
      app: postgresql-exporter
  endpoints:
  - port: metrics
    path: /metrics
    interval: 15s
    scrapeTimeout: 10s
---
apiVersion: v1
kind: ServiceMonitor
metadata:
  name: redis-exporter
  namespace: database
  labels:
    app: redis-exporter
spec:
  selector:
    matchLabels:
      app: redis-exporter
  endpoints:
  - port: metrics
    path: /metrics
    interval: 15s
    scrapeTimeout: 10s
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgresql-exporter
  namespace: database
  labels:
    app: postgresql-exporter
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgresql-exporter
  template:
    metadata:
      labels:
        app: postgresql-exporter
    spec:
      containers:
      - name: postgresql-exporter
        image: quay.io/prometheuscommunity/postgres-exporter:v0.15.0
        ports:
        - containerPort: 9187
          name: metrics
        env:
        - name: DATA_SOURCE_URI
          value: "waqiti-postgres-primary.database.svc.cluster.local:5432/postgres?sslmode=require"
        - name: DATA_SOURCE_USER
          valueFrom:
            secretKeyRef:
              name: postgres-credentials
              key: username
        - name: DATA_SOURCE_PASS
          valueFrom:
            secretKeyRef:
              name: postgres-credentials
              key: password
        - name: PG_EXPORTER_EXTEND_QUERY_PATH
          value: "/etc/postgres-exporter/queries.yaml"
        volumeMounts:
        - name: queries-config
          mountPath: /etc/postgres-exporter
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
        livenessProbe:
          httpGet:
            path: /metrics
            port: 9187
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /metrics
            port: 9187
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: queries-config
        configMap:
          name: postgres-exporter-queries
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-exporter-queries
  namespace: database
data:
  queries.yaml: |
    pg_replication_lag_seconds:
      query: "SELECT CASE WHEN NOT pg_is_in_recovery() THEN 0 ELSE GREATEST (0, EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp()))) END AS lag"
      master: true
      metrics:
        - lag:
            usage: "GAUGE"
            description: "Replication lag behind master in seconds"
            
    pg_last_backup_timestamp:
      query: "SELECT EXTRACT(EPOCH FROM MAX(backup_stop_time)) as last_backup FROM pg_stat_archiver"
      master: true
      metrics:
        - last_backup:
            usage: "GAUGE"
            description: "Timestamp of last successful backup"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-exporter
  namespace: database
  labels:
    app: redis-exporter
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis-exporter
  template:
    metadata:
      labels:
        app: redis-exporter
    spec:
      containers:
      - name: redis-exporter
        image: oliver006/redis_exporter:v1.55.0
        ports:
        - containerPort: 9121
          name: metrics
        env:
        - name: REDIS_ADDR
          value: "redis://redis-cluster.database.svc.cluster.local:6379"
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: redis-credentials
              key: password
        - name: REDIS_EXPORTER_LOG_FORMAT
          value: "json"
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
        livenessProbe:
          httpGet:
            path: /metrics
            port: 9121
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /metrics
            port: 9121
          initialDelaySeconds: 5
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: postgresql-exporter
  namespace: database
  labels:
    app: postgresql-exporter
spec:
  ports:
  - port: 9187
    targetPort: 9187
    name: metrics
  selector:
    app: postgresql-exporter
---
apiVersion: v1
kind: Service
metadata:
  name: redis-exporter
  namespace: database
  labels:
    app: redis-exporter
spec:
  ports:
  - port: 9121
    targetPort: 9121
    name: metrics
  selector:
    app: redis-exporter