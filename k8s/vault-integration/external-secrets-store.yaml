# =============================================================================
# HashiCorp Vault Integration via External Secrets Operator
# CRITICAL FIX (P0-009): Production-ready Vault secret management
#
# This replaces all ${vault.*:VAULT_SECRET_REQUIRED} placeholders with actual
# secrets dynamically fetched from HashiCorp Vault at runtime.
#
# Architecture:
# 1. External Secrets Operator (ESO) installed in cluster
# 2. SecretStore defines connection to Vault
# 3. ExternalSecret resources map Vault paths to K8s Secrets
# 4. Pods consume secrets via environment variables or volume mounts
#
# Security Benefits:
# - Secrets never committed to Git
# - Automatic rotation when Vault secrets change
# - Audit trail in Vault for all secret access
# - Fine-grained RBAC via Vault policies
# - Secrets encrypted at rest and in transit
#
# =============================================================================

apiVersion: v1
kind: Namespace
metadata:
  name: external-secrets
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/part-of: waqiti-platform

---
# =============================================================================
# Vault Authentication Service Account
# =============================================================================
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault-auth
  namespace: external-secrets
  labels:
    app: vault-auth

---
# =============================================================================
# SecretStore: Connection to HashiCorp Vault
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-backend
  namespace: external-secrets
spec:
  provider:
    vault:
      server: "${VAULT_ADDR}"  # Set via environment: https://vault.example.com:8200
      path: "secret"  # KV v2 secrets engine mount path
      version: "v2"   # KV version 2 (with versioning and metadata)

      auth:
        # Kubernetes authentication method (recommended for K8s)
        kubernetes:
          mountPath: "kubernetes"  # Vault Kubernetes auth mount path
          role: "external-secrets-role"  # Vault role with appropriate policies
          serviceAccountRef:
            name: vault-auth

          # Alternative: AppRole authentication (for non-K8s environments)
          # appRole:
          #   path: "approle"
          #   roleId: "${VAULT_ROLE_ID}"
          #   secretRef:
          #     name: vault-approle-secret
          #     key: secret-id

---
# =============================================================================
# ClusterSecretStore: Cluster-wide access to Vault
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: vault-backend-cluster
spec:
  provider:
    vault:
      server: "${VAULT_ADDR}"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "waqiti-platform-role"
          serviceAccountRef:
            name: vault-auth
            namespace: external-secrets

---
# =============================================================================
# ExternalSecret: Database Credentials for All Services
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: database-credentials
  namespace: waqiti
spec:
  refreshInterval: 1h  # Refresh from Vault every hour
  secretStoreRef:
    name: vault-backend-cluster
    kind: ClusterSecretStore

  target:
    name: database-credentials  # Name of the Kubernetes Secret to create
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # PostgreSQL main database
        POSTGRES_PASSWORD: "{{ .postgres_password }}"
        POSTGRES_USER: "{{ .postgres_user }}"

        # Per-service database passwords
        USER_DB_PASSWORD: "{{ .user_db_password }}"
        PAYMENT_DB_PASSWORD: "{{ .payment_db_password }}"
        WALLET_DB_PASSWORD: "{{ .wallet_db_password }}"
        LEDGER_DB_PASSWORD: "{{ .ledger_db_password }}"
        COMPLIANCE_DB_PASSWORD: "{{ .compliance_db_password }}"
        ANALYTICS_DB_PASSWORD: "{{ .analytics_db_password }}"
        SECURITY_DB_PASSWORD: "{{ .security_db_password }}"
        NOTIFICATION_DB_PASSWORD: "{{ .notification_db_password }}"

  data:
    - secretKey: postgres_password
      remoteRef:
        key: database/postgres
        property: password

    - secretKey: postgres_user
      remoteRef:
        key: database/postgres
        property: username

    - secretKey: user_db_password
      remoteRef:
        key: database/user-service
        property: password

    - secretKey: payment_db_password
      remoteRef:
        key: database/payment-service
        property: password

    - secretKey: wallet_db_password
      remoteRef:
        key: database/wallet-service
        property: password

    - secretKey: ledger_db_password
      remoteRef:
        key: database/ledger-service
        property: password

    - secretKey: compliance_db_password
      remoteRef:
        key: database/compliance-service
        property: password

    - secretKey: analytics_db_password
      remoteRef:
        key: database/analytics-service
        property: password

    - secretKey: security_db_password
      remoteRef:
        key: database/security-service
        property: password

    - secretKey: notification_db_password
      remoteRef:
        key: database/notification-service
        property: password

---
# =============================================================================
# ExternalSecret: JWT and Encryption Keys
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: jwt-secrets
  namespace: waqiti
spec:
  refreshInterval: 24h  # Refresh daily
  secretStoreRef:
    name: vault-backend-cluster
    kind: ClusterSecretStore

  target:
    name: jwt-secrets
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        JWT_SECRET: "{{ .jwt_secret }}"
        JWT_REFRESH_SECRET: "{{ .jwt_refresh_secret }}"
        ENCRYPTION_KEY: "{{ .encryption_key }}"
        API_SECRET_KEY: "{{ .api_secret_key }}"
        ACH_ENCRYPTION_KEY: "{{ .ach_encryption_key }}"
        PAYMENT_ENCRYPTION_KEY: "{{ .payment_encryption_key }}"

  data:
    - secretKey: jwt_secret
      remoteRef:
        key: jwt/payment-service
        property: secret

    - secretKey: jwt_refresh_secret
      remoteRef:
        key: jwt/payment-service
        property: refresh-secret

    - secretKey: encryption_key
      remoteRef:
        key: encryption/platform
        property: master-key

    - secretKey: api_secret_key
      remoteRef:
        key: api/platform
        property: secret-key

    - secretKey: ach_encryption_key
      remoteRef:
        key: encryption/payment-service
        property: ach-key

    - secretKey: payment_encryption_key
      remoteRef:
        key: encryption/payment-service
        property: payment-key

---
# =============================================================================
# ExternalSecret: Keycloak Credentials
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: keycloak-credentials
  namespace: waqiti
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend-cluster
    kind: ClusterSecretStore

  target:
    name: keycloak-credentials
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        KEYCLOAK_ADMIN: "{{ .admin_username }}"
        KEYCLOAK_ADMIN_PASSWORD: "{{ .admin_password }}"
        KEYCLOAK_USER_SERVICE_CLIENT_SECRET: "{{ .user_service_client_secret }}"
        KEYCLOAK_PAYMENT_SERVICE_CLIENT_SECRET: "{{ .payment_service_client_secret }}"
        KEYCLOAK_WALLET_SERVICE_CLIENT_SECRET: "{{ .wallet_service_client_secret }}"

  data:
    - secretKey: admin_username
      remoteRef:
        key: keycloak/admin
        property: username

    - secretKey: admin_password
      remoteRef:
        key: keycloak/admin
        property: password

    - secretKey: user_service_client_secret
      remoteRef:
        key: keycloak/user-service
        property: client-secret

    - secretKey: payment_service_client_secret
      remoteRef:
        key: keycloak/payment-service
        property: client-secret

    - secretKey: wallet_service_client_secret
      remoteRef:
        key: keycloak/wallet-service
        property: client-secret

---
# =============================================================================
# ExternalSecret: Third-Party API Keys
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: api-keys
  namespace: waqiti
spec:
  refreshInterval: 12h
  secretStoreRef:
    name: vault-backend-cluster
    kind: ClusterSecretStore

  target:
    name: api-keys
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # Payment providers
        STRIPE_API_KEY: "{{ .stripe_secret_key }}"
        STRIPE_WEBHOOK_SECRET: "{{ .stripe_webhook_secret }}"
        PAYPAL_CLIENT_ID: "{{ .paypal_client_id }}"
        PAYPAL_CLIENT_SECRET: "{{ .paypal_client_secret }}"
        PLAID_CLIENT_ID: "{{ .plaid_client_id }}"
        PLAID_SECRET: "{{ .plaid_secret }}"

        # Communication providers
        TWILIO_ACCOUNT_SID: "{{ .twilio_account_sid }}"
        TWILIO_AUTH_TOKEN: "{{ .twilio_auth_token }}"
        SENDGRID_API_KEY: "{{ .sendgrid_api_key }}"

        # Banking providers
        WISE_API_TOKEN: "{{ .wise_api_token }}"
        DWOLLA_API_KEY: "{{ .dwolla_key }}"
        DWOLLA_API_SECRET: "{{ .dwolla_secret }}"

  data:
    # Stripe
    - secretKey: stripe_secret_key
      remoteRef:
        key: api-keys/stripe
        property: secret-key

    - secretKey: stripe_webhook_secret
      remoteRef:
        key: api-keys/stripe
        property: webhook-secret

    # PayPal
    - secretKey: paypal_client_id
      remoteRef:
        key: api-keys/paypal
        property: client-id

    - secretKey: paypal_client_secret
      remoteRef:
        key: api-keys/paypal
        property: client-secret

    # Plaid
    - secretKey: plaid_client_id
      remoteRef:
        key: api-keys/plaid
        property: client-id

    - secretKey: plaid_secret
      remoteRef:
        key: api-keys/plaid
        property: secret

    # Twilio
    - secretKey: twilio_account_sid
      remoteRef:
        key: api-keys/twilio
        property: account-sid

    - secretKey: twilio_auth_token
      remoteRef:
        key: api-keys/twilio
        property: auth-token

    # SendGrid
    - secretKey: sendgrid_api_key
      remoteRef:
        key: api-keys/sendgrid
        property: api-key

    # Wise
    - secretKey: wise_api_token
      remoteRef:
        key: api-keys/wise
        property: api-token

    # Dwolla
    - secretKey: dwolla_key
      remoteRef:
        key: api-keys/dwolla
        property: key

    - secretKey: dwolla_secret
      remoteRef:
        key: api-keys/dwolla
        property: secret

---
# =============================================================================
# ExternalSecret: Redis Credentials
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: redis-credentials
  namespace: waqiti
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend-cluster
    kind: ClusterSecretStore

  target:
    name: redis-credentials
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        REDIS_PASSWORD: "{{ .redis_password }}"

  data:
    - secretKey: redis_password
      remoteRef:
        key: redis/password
        property: password

---
# =============================================================================
# ExternalSecret: Kafka SSL Certificates and Passwords
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: kafka-ssl
  namespace: waqiti
spec:
  refreshInterval: 24h
  secretStoreRef:
    name: vault-backend-cluster
    kind: ClusterSecretStore

  target:
    name: kafka-ssl
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        KAFKA_SSL_KEYSTORE_PASSWORD: "{{ .keystore_password }}"
        KAFKA_SSL_KEY_PASSWORD: "{{ .key_password }}"
        KAFKA_SSL_TRUSTSTORE_PASSWORD: "{{ .truststore_password }}"

  data:
    - secretKey: keystore_password
      remoteRef:
        key: kafka/ssl
        property: keystore-password

    - secretKey: key_password
      remoteRef:
        key: kafka/ssl
        property: key-password

    - secretKey: truststore_password
      remoteRef:
        key: kafka/ssl
        property: truststore-password

---
# =============================================================================
# ExternalSecret: Monitoring Credentials
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: monitoring-credentials
  namespace: waqiti
spec:
  refreshInterval: 24h
  secretStoreRef:
    name: vault-backend-cluster
    kind: ClusterSecretStore

  target:
    name: monitoring-credentials
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        GRAFANA_PASSWORD: "{{ .grafana_password }}"
        PROMETHEUS_BASIC_AUTH: "{{ .prometheus_auth }}"

  data:
    - secretKey: grafana_password
      remoteRef:
        key: monitoring/grafana
        property: admin-password

    - secretKey: prometheus_auth
      remoteRef:
        key: monitoring/prometheus
        property: basic-auth
