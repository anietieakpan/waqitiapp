---
# Vault StatefulSet with TLS Enabled
# Description: Production-grade Vault deployment with HA, TLS 1.3, and auto-unseal
# Security: mTLS, encrypted storage, AWS KMS auto-unseal
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault
  namespace: vault-production
  labels:
    app: vault
    component: server
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: vault-server
  labels:
    app: vault
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "watch", "create", "update"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: vault-server-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: vault-server
subjects:
  - kind: ServiceAccount
    name: vault
    namespace: vault-production
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-config
  namespace: vault-production
  labels:
    app: vault
data:
  vault.hcl: |
    # Production Vault Configuration with TLS
    storage "consul" {
      address = "consul:8500"
      path    = "vault/"
      token   = "${CONSUL_TOKEN}"
      ha_enabled = "true"
      tls_ca_file   = "/vault/tls/ca.pem"
      tls_cert_file = "/vault/tls/consul-cert.pem"
      tls_key_file  = "/vault/tls/consul-key.pem"
    }

    listener "tcp" {
      address       = "0.0.0.0:8200"
      tls_disable   = "false"
      tls_cert_file = "/vault/tls/vault-cert.pem"
      tls_key_file  = "/vault/tls/vault-key.pem"
      tls_client_ca_file = "/vault/tls/ca.pem"
      tls_min_version = "tls13"
      tls_require_and_verify_client_cert = "true"
      tls_cipher_suites = "TLS_AES_256_GCM_SHA384,TLS_AES_128_GCM_SHA256"
    }

    listener "tcp" {
      address       = "0.0.0.0:8201"
      cluster_address = "0.0.0.0:8201"
      tls_disable   = "false"
      tls_cert_file = "/vault/tls/vault-cert.pem"
      tls_key_file  = "/vault/tls/vault-key.pem"
      tls_client_ca_file = "/vault/tls/ca.pem"
      tls_require_and_verify_client_cert = "true"
    }

    ui = true

    seal "awskms" {
      region     = "us-east-1"
      kms_key_id = "alias/waqiti-vault-unseal-key"
    }

    api_addr     = "https://vault.example.com:8200"
    cluster_addr = "https://$(POD_NAME).vault-internal:8201"
    log_level    = "INFO"
    log_format   = "json"
    disable_mlock = false
    max_lease_ttl = "768h"
    default_lease_ttl = "168h"
    plugin_directory = "/vault/plugins"
    cluster_name = "waqiti-vault-prod"
---
apiVersion: v1
kind: Service
metadata:
  name: vault
  namespace: vault-production
  labels:
    app: vault
    component: server
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "tcp"
    service.beta.kubernetes.io/aws-load-balancer-ssl-ports: "8200"
spec:
  type: LoadBalancer
  publishNotReadyAddresses: true
  ports:
    - name: https
      port: 8200
      targetPort: 8200
      protocol: TCP
    - name: https-internal
      port: 8201
      targetPort: 8201
      protocol: TCP
  selector:
    app: vault
    component: server
---
apiVersion: v1
kind: Service
metadata:
  name: vault-internal
  namespace: vault-production
  labels:
    app: vault
    component: server
spec:
  type: ClusterIP
  clusterIP: None  # Headless service for StatefulSet
  publishNotReadyAddresses: true
  ports:
    - name: https
      port: 8200
      targetPort: 8200
      protocol: TCP
    - name: https-internal
      port: 8201
      targetPort: 8201
      protocol: TCP
  selector:
    app: vault
    component: server
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: vault
  namespace: vault-production
  labels:
    app: vault
    component: server
spec:
  serviceName: vault-internal
  replicas: 3  # HA cluster
  selector:
    matchLabels:
      app: vault
      component: server
  template:
    metadata:
      labels:
        app: vault
        component: server
    spec:
      serviceAccountName: vault
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  app: vault
              topologyKey: kubernetes.io/hostname
      securityContext:
        runAsNonRoot: true
        runAsUser: 100
        runAsGroup: 1000
        fsGroup: 1000
      containers:
        - name: vault
          image: hashicorp/vault:1.15.4
          imagePullPolicy: IfNotPresent
          command: ["vault", "server", "-config=/vault/config/vault.hcl"]
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: VAULT_ADDR
              value: "https://127.0.0.1:8200"
            - name: VAULT_API_ADDR
              value: "https://$(POD_NAME).vault-internal:8200"
            - name: VAULT_CLUSTER_ADDR
              value: "https://$(POD_NAME).vault-internal:8201"
            - name: VAULT_CACERT
              value: "/vault/tls/ca.pem"
            - name: VAULT_TLSCERT
              value: "/vault/tls/vault-cert.pem"
            - name: VAULT_TLSKEY
              value: "/vault/tls/vault-key.pem"
            - name: CONSUL_TOKEN
              valueFrom:
                secretKeyRef:
                  name: vault-consul-token
                  key: token
            - name: AWS_REGION
              value: "us-east-1"
          ports:
            - name: https
              containerPort: 8200
              protocol: TCP
            - name: https-internal
              containerPort: 8201
              protocol: TCP
          resources:
            requests:
              memory: "256Mi"
              cpu: "250m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
              add:
                - IPC_LOCK  # Required for mlock
            readOnlyRootFilesystem: true
          volumeMounts:
            - name: config
              mountPath: /vault/config
              readOnly: true
            - name: tls
              mountPath: /vault/tls
              readOnly: true
            - name: data
              mountPath: /vault/data
            - name: plugins
              mountPath: /vault/plugins
            - name: tmp
              mountPath: /tmp
          livenessProbe:
            httpGet:
              path: /v1/sys/health?standbyok=true
              port: 8200
              scheme: HTTPS
              httpHeaders:
                - name: X-Vault-Request
                  value: "true"
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /v1/sys/health?standbyok=true&sealedcode=204&uninitcode=204
              port: 8200
              scheme: HTTPS
              httpHeaders:
                - name: X-Vault-Request
                  value: "true"
            initialDelaySeconds: 30
            periodSeconds: 5
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 2
      volumes:
        - name: config
          configMap:
            name: vault-config
        - name: tls
          secret:
            secretName: vault-tls
            defaultMode: 0400  # Read-only for owner
        - name: plugins
          emptyDir: {}
        - name: tmp
          emptyDir: {}
  volumeClaimTemplates:
    - metadata:
        name: data
        labels:
          app: vault
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: fast-ssd
        resources:
          requests:
            storage: 10Gi
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: vault-pdb
  namespace: vault-production
spec:
  minAvailable: 2  # At least 2 pods must be available during disruptions
  selector:
    matchLabels:
      app: vault
      component: server
---
apiVersion: v1
kind: Secret
metadata:
  name: vault-consul-token
  namespace: vault-production
  labels:
    app: vault
type: Opaque
stringData:
  # CONFIGURE_IN_VAULT: Replace with actual Consul token via sealed-secrets or external-secrets
  token: "CHANGE_ME_CONSUL_TOKEN"
