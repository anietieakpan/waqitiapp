# ============================================================================
# KAFKA SECURITY CONFIGURATION
# ============================================================================
# Implements comprehensive Kafka security:
# - TLS/SSL encryption for data in transit
# - SASL/SCRAM authentication
# - ACLs (Access Control Lists) for authorization
# - Network isolation
#
# COMPLIANCE: PCI-DSS 4.1, 4.2 (Encryption), GDPR (Data Protection)
# ============================================================================

---
# Kafka Broker Configuration with Security
apiVersion: v1
kind: ConfigMap
metadata:
  name: kafka-server-config
  namespace: waqiti-production
  labels:
    app: kafka
    component: broker
data:
  server.properties: |
    # ========================================================================
    # BASIC BROKER CONFIGURATION
    # ========================================================================
    broker.id=-1  # Auto-generate broker ID
    num.network.threads=8
    num.io.threads=16
    socket.send.buffer.bytes=102400
    socket.receive.buffer.bytes=102400
    socket.request.max.bytes=104857600
    log.dirs=/var/lib/kafka/data
    num.partitions=3
    num.recovery.threads.per.data.dir=1
    offsets.topic.replication.factor=3
    transaction.state.log.replication.factor=3
    transaction.state.log.min.isr=2
    log.retention.hours=168
    log.segment.bytes=1073741824
    log.retention.check.interval.ms=300000

    # ========================================================================
    # ZOOKEEPER CONNECTION
    # ========================================================================
    zookeeper.connect=zookeeper:2181
    zookeeper.connection.timeout.ms=18000

    # ========================================================================
    # SECURITY CONFIGURATION - LISTENERS
    # ========================================================================
    # CRITICAL: Define multiple listeners with different security protocols

    # Listener names
    listener.security.protocol.map=INTERNAL:SASL_SSL,EXTERNAL:SASL_SSL,PLAINTEXT_INTERNAL:PLAINTEXT

    # Listeners
    # INTERNAL: Secure inter-broker communication (SASL/SSL)
    # EXTERNAL: Secure client communication (SASL/SSL)
    # PLAINTEXT_INTERNAL: For migration only (should be removed in production)
    listeners=INTERNAL://0.0.0.0:9093,EXTERNAL://0.0.0.0:9092,PLAINTEXT_INTERNAL://0.0.0.0:9094

    # Advertised listeners (what clients connect to)
    advertised.listeners=INTERNAL://kafka:9093,EXTERNAL://kafka:9092

    # Inter-broker communication uses secure INTERNAL listener
    inter.broker.listener.name=INTERNAL

    # ========================================================================
    # SSL/TLS CONFIGURATION
    # ========================================================================

    # SSL Keystore (broker's private key and certificate)
    ssl.keystore.location=/etc/kafka/secrets/kafka.server.keystore.jks
    ssl.keystore.password=${KAFKA_KEYSTORE_PASSWORD}
    ssl.key.password=${KAFKA_KEY_PASSWORD}

    # SSL Truststore (CA certificates)
    ssl.truststore.location=/etc/kafka/secrets/kafka.server.truststore.jks
    ssl.truststore.password=${KAFKA_TRUSTSTORE_PASSWORD}

    # SSL client authentication (mTLS)
    ssl.client.auth=required

    # SSL protocol and cipher suites
    ssl.protocol=TLSv1.3
    ssl.enabled.protocols=TLSv1.3,TLSv1.2
    ssl.cipher.suites=TLS_AES_256_GCM_SHA384,TLS_AES_128_GCM_SHA256

    # SSL endpoint identification (hostname verification)
    ssl.endpoint.identification.algorithm=https

    # ========================================================================
    # SASL AUTHENTICATION CONFIGURATION
    # ========================================================================

    # SASL mechanism: SCRAM-SHA-512 (stronger than SCRAM-SHA-256)
    sasl.mechanism.inter.broker.protocol=SCRAM-SHA-512
    sasl.enabled.mechanisms=SCRAM-SHA-512,SCRAM-SHA-256

    # JAAS configuration for broker
    listener.name.internal.scram-sha-512.sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required \
      username="kafka-broker" \
      password="${KAFKA_BROKER_PASSWORD}";

    listener.name.external.scram-sha-512.sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required \
      username="kafka-broker" \
      password="${KAFKA_BROKER_PASSWORD}";

    # ========================================================================
    # AUTHORIZATION (ACLs)
    # ========================================================================

    # Enable ACL authorization
    authorizer.class.name=kafka.security.authorizer.AclAuthorizer

    # Super users (full access without ACL checks)
    super.users=User:admin;User:kafka-broker

    # Allow everyone to access if no ACL found (CRITICAL: Set to false in production)
    allow.everyone.if.no.acl.found=false

    # ========================================================================
    # SECURITY - ADDITIONAL SETTINGS
    # ========================================================================

    # Disable auto topic creation (force explicit creation with proper ACLs)
    auto.create.topics.enable=false

    # Minimum in-sync replicas (for durability)
    min.insync.replicas=2

    # Leader election (wait for clean leader election)
    unclean.leader.election.enable=false

    # ========================================================================
    # MONITORING & METRICS
    # ========================================================================

    # JMX monitoring
    jmx.port=9999

    # Metrics reporters
    metric.reporters=io.confluent.metrics.reporter.ConfluentMetricsReporter
    confluent.metrics.reporter.bootstrap.servers=kafka:9093
    confluent.metrics.reporter.security.protocol=SASL_SSL
    confluent.metrics.reporter.sasl.mechanism=SCRAM-SHA-512

    # ========================================================================
    # LOG CONFIGURATION
    # ========================================================================

    # Log4j configuration
    log4j.rootLogger=INFO, stdout, kafkaAppender
    log4j.appender.stdout=org.apache.log4j.ConsoleAppender
    log4j.appender.stdout.layout=org.apache.log4j.PatternLayout
    log4j.appender.stdout.layout.ConversionPattern=[%d] %p %m (%c)%n

    # Audit logging (security events)
    log4j.logger.kafka.authorizer.logger=INFO, authorizerAppender
    log4j.additivity.kafka.authorizer.logger=false
    log4j.appender.authorizerAppender=org.apache.log4j.DailyRollingFileAppender
    log4j.appender.authorizerAppender.DatePattern='.'yyyy-MM-dd-HH
    log4j.appender.authorizerAppender.File=/var/log/kafka/kafka-authorizer.log
    log4j.appender.authorizerAppender.layout=org.apache.log4j.PatternLayout
    log4j.appender.authorizerAppender.layout.ConversionPattern=[%d] %p %m (%c)%n

---
# Kafka ACL Configuration Script
apiVersion: v1
kind: ConfigMap
metadata:
  name: kafka-acl-setup
  namespace: waqiti-production
data:
  setup-acls.sh: |
    #!/bin/bash
    set -e

    echo "==================================================="
    echo "Setting up Kafka ACLs for Waqiti Platform"
    echo "==================================================="

    KAFKA_BIN="/opt/kafka/bin"
    BOOTSTRAP_SERVER="kafka:9093"

    # Wait for Kafka to be ready
    echo "Waiting for Kafka to be ready..."
    until $KAFKA_BIN/kafka-broker-api-versions.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties > /dev/null 2>&1; do
      echo "Kafka not ready yet, waiting..."
      sleep 5
    done

    echo "Kafka is ready. Creating ACLs..."

    # ========================================================================
    # PAYMENT SERVICE ACLs
    # ========================================================================
    echo "Creating ACLs for Payment Service..."

    # Allow payment-service to produce to payment topics
    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties \
      --add --allow-principal User:payment-service \
      --operation Write --topic payment.events

    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties \
      --add --allow-principal User:payment-service \
      --operation Write --topic payment.commands

    # Allow payment-service to consume from payment topics
    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties \
      --add --allow-principal User:payment-service \
      --operation Read --topic payment.events \
      --group payment-service

    # Allow payment-service to describe topics
    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties \
      --add --allow-principal User:payment-service \
      --operation Describe --topic payment.events

    # ========================================================================
    # WALLET SERVICE ACLs
    # ========================================================================
    echo "Creating ACLs for Wallet Service..."

    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties \
      --add --allow-principal User:wallet-service \
      --operation Write --topic wallet.events

    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties \
      --add --allow-principal User:wallet-service \
      --operation Read --topic wallet.events \
      --group wallet-service

    # Wallet service needs to consume payment events
    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties \
      --add --allow-principal User:wallet-service \
      --operation Read --topic payment.events \
      --group wallet-service

    # ========================================================================
    # TRANSACTION SERVICE ACLs
    # ========================================================================
    echo "Creating ACLs for Transaction Service..."

    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties \
      --add --allow-principal User:transaction-service \
      --operation Write --topic transaction.events

    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties \
      --add --allow-principal User:transaction-service \
      --operation Read --topic transaction.events \
      --group transaction-service

    # Transaction service consumes from payment and wallet topics
    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties \
      --add --allow-principal User:transaction-service \
      --operation Read --topic payment.events \
      --group transaction-service

    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties \
      --add --allow-principal User:transaction-service \
      --operation Read --topic wallet.events \
      --group transaction-service

    # ========================================================================
    # FRAUD DETECTION SERVICE ACLs
    # ========================================================================
    echo "Creating ACLs for Fraud Detection Service..."

    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties \
      --add --allow-principal User:fraud-detection-service \
      --operation Write --topic fraud.alerts

    # Fraud service needs to consume from all financial topics
    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties \
      --add --allow-principal User:fraud-detection-service \
      --operation Read --topic payment.events \
      --group fraud-detection-service

    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties \
      --add --allow-principal User:fraud-detection-service \
      --operation Read --topic transaction.events \
      --group fraud-detection-service

    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties \
      --add --allow-principal User:fraud-detection-service \
      --operation Read --topic wallet.events \
      --group fraud-detection-service

    # ========================================================================
    # COMPLIANCE SERVICE ACLs
    # ========================================================================
    echo "Creating ACLs for Compliance Service..."

    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties \
      --add --allow-principal User:compliance-service \
      --operation Write --topic compliance.events

    # Compliance needs read access to all topics for monitoring
    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties \
      --add --allow-principal User:compliance-service \
      --operation Read --topic payment.events \
      --group compliance-service

    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties \
      --add --allow-principal User:compliance-service \
      --operation Read --topic transaction.events \
      --group compliance-service

    # ========================================================================
    # AUDIT SERVICE ACLs
    # ========================================================================
    echo "Creating ACLs for Audit Service..."

    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties \
      --add --allow-principal User:audit-service \
      --operation Write --topic audit.events

    # Audit service needs to consume from all topics
    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties \
      --add --allow-principal User:audit-service \
      --operation Read --topic '*' \
      --group audit-service

    # ========================================================================
    # NOTIFICATION SERVICE ACLs
    # ========================================================================
    echo "Creating ACLs for Notification Service..."

    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties \
      --add --allow-principal User:notification-service \
      --operation Write --topic notification.events

    # Notification service consumes from multiple topics
    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties \
      --add --allow-principal User:notification-service \
      --operation Read --topic payment.events \
      --group notification-service

    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties \
      --add --allow-principal User:notification-service \
      --operation Read --topic transaction.events \
      --group notification-service

    # ========================================================================
    # GDPR SERVICE ACLs
    # ========================================================================
    echo "Creating ACLs for GDPR Service..."

    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties \
      --add --allow-principal User:gdpr-service \
      --operation Write --topic gdpr.events

    echo "==================================================="
    echo "Kafka ACL setup completed successfully!"
    echo "==================================================="

    # List all ACLs for verification
    echo "Current ACLs:"
    $KAFKA_BIN/kafka-acls.sh --bootstrap-server $BOOTSTRAP_SERVER --command-config /etc/kafka/client.properties --list

---
# Client Configuration Template (for services)
apiVersion: v1
kind: ConfigMap
metadata:
  name: kafka-client-config-template
  namespace: waqiti-production
data:
  client.properties: |
    # ========================================================================
    # KAFKA CLIENT SECURITY CONFIGURATION
    # ========================================================================
    # This configuration should be used by all services connecting to Kafka
    # ========================================================================

    # Bootstrap servers (use secure port)
    bootstrap.servers=kafka:9092

    # Security protocol
    security.protocol=SASL_SSL

    # SASL mechanism
    sasl.mechanism=SCRAM-SHA-512

    # SASL JAAS configuration (credentials from environment)
    sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required \
      username="${KAFKA_USERNAME}" \
      password="${KAFKA_PASSWORD}";

    # SSL truststore configuration
    ssl.truststore.location=/etc/kafka/secrets/kafka.client.truststore.jks
    ssl.truststore.password=${KAFKA_TRUSTSTORE_PASSWORD}

    # SSL endpoint identification
    ssl.endpoint.identification.algorithm=https

    # ========================================================================
    # PRODUCER SETTINGS
    # ========================================================================

    # Idempotence for exactly-once semantics
    enable.idempotence=true

    # Acknowledgements (wait for all in-sync replicas)
    acks=all

    # Retries
    retries=2147483647
    max.in.flight.requests.per.connection=5

    # Compression
    compression.type=snappy

    # ========================================================================
    # CONSUMER SETTINGS
    # ========================================================================

    # Isolation level for transactional reads
    isolation.level=read_committed

    # Auto-offset reset
    auto.offset.reset=earliest

    # Enable auto-commit (set to false for manual commit)
    enable.auto.commit=false

---
# Spring Boot application.yml template for Kafka security
apiVersion: v1
kind: ConfigMap
metadata:
  name: spring-kafka-security-config
  namespace: waqiti-production
data:
  kafka-security.yml: |
    spring:
      kafka:
        bootstrap-servers: kafka:9092

        # Security configuration
        security:
          protocol: SASL_SSL

        properties:
          # SASL configuration
          sasl.mechanism: SCRAM-SHA-512
          sasl.jaas.config: org.apache.kafka.common.security.scram.ScramLoginModule required username="${KAFKA_USERNAME}" password="${KAFKA_PASSWORD}";

          # SSL configuration
          ssl.truststore.location: /etc/kafka/secrets/kafka.client.truststore.jks
          ssl.truststore.password: ${KAFKA_TRUSTSTORE_PASSWORD}
          ssl.endpoint.identification.algorithm: https
          ssl.protocol: TLSv1.3

        # Producer configuration
        producer:
          acks: all
          retries: 3
          enable-idempotence: true
          compression-type: snappy

          # Serializers
          key-serializer: org.apache.kafka.common.serialization.StringSerializer
          value-serializer: org.springframework.kafka.support.serializer.JsonSerializer

        # Consumer configuration
        consumer:
          enable-auto-commit: false
          isolation-level: read_committed
          auto-offset-reset: earliest

          # Deserializers
          key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
          value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer

          properties:
            spring.json.trusted.packages: "com.waqiti.*"

        # Listener configuration
        listener:
          ack-mode: manual_immediate

---
# SUMMARY
# ============================================================================
# KAFKA SECURITY IMPLEMENTATION CHECKLIST:
#
# ✅ TLS/SSL Encryption
#    - TLSv1.3 with strong cipher suites
#    - mTLS (mutual TLS) for client authentication
#    - Certificate-based identity verification
#
# ✅ SASL Authentication
#    - SCRAM-SHA-512 mechanism (stronger than SHA-256)
#    - Separate credentials per service
#    - Credential rotation support
#
# ✅ Authorization (ACLs)
#    - Least privilege principle
#    - Service-specific topic access
#    - Consumer group isolation
#    - Admin operations restricted to super users
#
# ✅ Additional Security Measures
#    - Disabled auto-topic creation
#    - Minimum in-sync replicas = 2
#    - Clean leader election only
#    - Audit logging enabled
#    - Network isolation (Kubernetes NetworkPolicy)
#
# ✅ Compliance
#    - PCI-DSS 4.1, 4.2 (Encryption in transit)
#    - GDPR (Data protection)
#    - SOX (Audit trail)
#
# DEPLOYMENT NOTES:
# 1. Generate SSL certificates for all brokers and clients
# 2. Create SCRAM credentials for all services
# 3. Apply Kafka configuration
# 4. Run ACL setup script
# 5. Update all services to use secure configuration
# 6. Verify with test messages
# 7. Monitor audit logs
# ============================================================================
