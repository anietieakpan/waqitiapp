apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault
  namespace: vault
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/VaultKMSUnsealRole
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-kms-config
  namespace: vault
data:
  aws-region: "us-east-1"
  kms-key-alias: "alias/vault-unseal-key"
---
# IAM Role for Service Account (IRSA) - to be created in AWS
# This is the AWS IAM policy that needs to be attached to the role
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-kms-policy
  namespace: vault
data:
  policy.json: |
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Action": [
            "kms:Encrypt",
            "kms:Decrypt",
            "kms:DescribeKey"
          ],
          "Resource": "arn:aws:kms:us-east-1:ACCOUNT_ID:key/*",
          "Condition": {
            "StringEquals": {
              "kms:KeyAlias": "alias/vault-unseal-key"
            }
          }
        }
      ]
    }
---
# TLS Certificate for Vault
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: vault-server-tls
  namespace: vault
spec:
  secretName: vault-server-tls
  issuerRef:
    name: vault-issuer
    kind: Issuer
  commonName: vault.example.internal
  dnsNames:
  - vault.example.internal
  - vault.vault.svc.cluster.local
  - vault-0.vault-internal
  - vault-1.vault-internal
  - vault-2.vault-internal
  - "*.vault-internal"
  - "*.vault-internal.vault.svc.cluster.local"
  ipAddresses:
  - 127.0.0.1
---
# Self-signed issuer for internal TLS
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: vault-issuer
  namespace: vault
spec:
  selfSigned: {}
---
# Network policy for Vault
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: vault-network-policy
  namespace: vault
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: vault
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow traffic from External Secrets Operator
  - from:
    - namespaceSelector:
        matchLabels:
          name: external-secrets-system
    - namespaceSelector:
        matchLabels:
          name: waqiti-system
    ports:
    - protocol: TCP
      port: 8200
  # Allow traffic from Vault injector
  - from:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: vault-agent-injector
    ports:
    - protocol: TCP
      port: 8200
  # Allow inter-node communication
  - from:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: vault
    ports:
    - protocol: TCP
      port: 8200
    - protocol: TCP
      port: 8201
  egress:
  # Allow DNS
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Allow access to Kubernetes API
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          component: kube-apiserver
    ports:
    - protocol: TCP
      port: 443
  # Allow access to AWS KMS
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443
  # Allow inter-node communication
  - to:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: vault
    ports:
    - protocol: TCP
      port: 8200
    - protocol: TCP
      port: 8201
---
# PodDisruptionBudget for Vault
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: vault-pdb
  namespace: vault
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: vault
      app.kubernetes.io/instance: vault
      component: server