apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: example-monitoring
  labels:
    app: otel-collector
    component: monitoring
data:
  config.yaml: |
    receivers:
      # OTLP receiver for traces, metrics, and logs
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
      
      # Prometheus receiver for metrics
      prometheus:
        config:
          scrape_configs:
            - job_name: 'otel-collector'
              scrape_interval: 30s
              static_configs:
                - targets: ['localhost:8888']
      
      # Jaeger receiver for traces
      jaeger:
        protocols:
          grpc:
            endpoint: 0.0.0.0:14250
          thrift_http:
            endpoint: 0.0.0.0:14268
          thrift_compact:
            endpoint: 0.0.0.0:6831
          thrift_binary:
            endpoint: 0.0.0.0:6832
      
      # Zipkin receiver for traces
      zipkin:
        endpoint: 0.0.0.0:9411
      
      # Kubernetes cluster receiver for K8s metrics
      k8s_cluster:
        auth_type: serviceAccount
        node_conditions_to_report: [Ready, MemoryPressure, DiskPressure, PIDPressure]
        distribution: kubernetes
        allocatable_types_to_report: [cpu, memory, storage]
      
      # Kubeletstats receiver for node/pod metrics
      kubeletstats:
        collection_interval: 20s
        auth_type: serviceAccount
        endpoint: ${K8S_NODE_NAME}:10250
        insecure_skip_verify: true
        metric_groups:
          - node
          - pod
          - container
          - volume
        extra_metadata_labels:
          - container.id
          - k8s.volume.type
      
      # File log receiver for application logs
      filelog:
        include:
          - /var/log/pods/*/*/*.log
        exclude:
          - /var/log/pods/*/otc-container/*.log
        start_at: end
        include_file_path: true
        include_file_name: false
        operators:
          - type: router
            id: get-format
            routes:
              - output: parser-docker
                expr: 'body matches "^\\{"'
              - output: parser-crio
                expr: 'body matches "^[^ Z]+ "'
              - output: parser-containerd
                expr: 'true'
          - type: regex_parser
            id: parser-crio
            regex: '^(?P<time>[^ Z]+) (?P<stream>stdout|stderr) (?P<logtag>[^ ]*) ?(?P<log>.*)$'
            timestamp:
              parse_from: attributes.time
              layout_type: gotime
              layout: '2006-01-02T15:04:05.000000000-07:00'
            severity:
              parse_from: attributes.stream
              mapping:
                stdout: info
                stderr: error
          - type: json_parser
            id: parser-docker
            timestamp:
              parse_from: attributes.time
              layout: '%Y-%m-%dT%H:%M:%S.%LZ'
          - type: regex_parser
            id: parser-containerd
            regex: '^(?P<time>[^ ^Z]+Z) (?P<stream>stdout|stderr) (?P<logtag>[^ ]*) ?(?P<log>.*)$'
            timestamp:
              parse_from: attributes.time
              layout: '%Y-%m-%dT%H:%M:%S.%LZ'
          - type: move
            from: attributes.log
            to: body
          - type: move
            from: attributes.stream
            to: attributes["log.iostream"]
          - type: move
            from: attributes.logtag
            to: attributes["log.tag"]
      
    processors:
      # Batch processor to improve performance
      batch:
        timeout: 1s
        send_batch_size: 1024
        send_batch_max_size: 2048
      
      # Memory limiter to prevent OOM
      memory_limiter:
        limit_mib: 512
        spike_limit_mib: 128
        check_interval: 5s
      
      # Resource processor to add metadata
      resource:
        attributes:
          - key: cluster.name
            value: "waqiti-production"
            action: upsert
          - key: environment
            value: "production"
            action: upsert
          - key: service.namespace
            from_attribute: k8s.namespace.name
            action: upsert
          - key: service.name
            from_attribute: k8s.deployment.name
            action: upsert
          - key: service.instance.id
            from_attribute: k8s.pod.name
            action: upsert
      
      # K8s attributes processor to add Kubernetes metadata
      k8sattributes:
        auth_type: serviceAccount
        passthrough: false
        filter:
          node_from_env_var: KUBE_NODE_NAME
        extract:
          metadata:
            - k8s.namespace.name
            - k8s.deployment.name
            - k8s.statefulset.name
            - k8s.daemonset.name
            - k8s.cronjob.name
            - k8s.job.name
            - k8s.node.name
            - k8s.pod.name
            - k8s.pod.uid
            - k8s.pod.start_time
          labels:
            - tag_name: app
              key: app
              from: pod
            - tag_name: version
              key: version
              from: pod
          annotations:
            - tag_name: service_name
              key: service.name
              from: pod
      
      # Transform processor for log enhancement
      transform:
        log_statements:
          - context: log
            statements:
              - set(severity_text, "INFO") where severity_text == nil
              - set(attributes["log.source"], "kubernetes") where attributes["log.source"] == nil
        metric_statements:
          - context: metric
            statements:
              - set(attributes["source"], "otel-collector") where attributes["source"] == nil
        trace_statements:
          - context: span
            statements:
              - set(attributes["cluster.name"], "waqiti-production") where attributes["cluster.name"] == nil

    exporters:
      # Prometheus exporter for metrics
      prometheus:
        endpoint: "0.0.0.0:8889"
        namespace: "waqiti"
        const_labels:
          cluster: "production"
        
      # Jaeger exporter for traces
      jaeger:
        endpoint: jaeger-collector:14250
        tls:
          insecure: true
      
      # OTLP exporter for sending to external systems
      otlp/jaeger:
        endpoint: jaeger-collector:4317
        tls:
          insecure: true
      
      # Elasticsearch exporter for logs
      elasticsearch:
        endpoints: ["http://elasticsearch:9200"]
        index: "waqiti-logs"
        mapping:
          mode: "ecs"
        logs_index: "waqiti-logs-{yyyy.MM.dd}"
        
      # Debug exporter for troubleshooting
      debug:
        verbosity: detailed
        sampling_initial: 5
        sampling_thereafter: 200
      
      # File exporter for backup
      file:
        path: /tmp/otel-output.json
        rotation:
          max_megabytes: 100
          max_days: 3
          max_backups: 3

    extensions:
      # Health check extension
      health_check:
        endpoint: 0.0.0.0:13133
      
      # Performance profiler
      pprof:
        endpoint: 0.0.0.0:1777
      
      # Metrics extension
      zpages:
        endpoint: 0.0.0.0:55679

    service:
      extensions: [health_check, pprof, zpages]
      pipelines:
        traces:
          receivers: [otlp, jaeger, zipkin]
          processors: [memory_limiter, k8sattributes, resource, batch]
          exporters: [jaeger, otlp/jaeger, debug]
        
        metrics:
          receivers: [otlp, prometheus, k8s_cluster, kubeletstats]
          processors: [memory_limiter, k8sattributes, resource, batch]
          exporters: [prometheus, debug]
        
        logs:
          receivers: [otlp, filelog]
          processors: [memory_limiter, k8sattributes, resource, transform, batch]
          exporters: [elasticsearch, debug]
      
      telemetry:
        logs:
          level: "info"
        metrics:
          level: "detailed"
          address: 0.0.0.0:8888
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: otel-collector
  namespace: example-monitoring
  labels:
    app: otel-collector
    component: monitoring
spec:
  selector:
    matchLabels:
      app: otel-collector
  template:
    metadata:
      labels:
        app: otel-collector
        component: monitoring
    spec:
      serviceAccountName: otel-collector
      containers:
      - name: otel-collector
        image: otel/opentelemetry-collector-contrib:0.89.0
        command:
          - "/otelcol-contrib"
          - "--config=/conf/config.yaml"
        ports:
        - containerPort: 4317   # OTLP gRPC receiver
          name: otlp-grpc
          protocol: TCP
        - containerPort: 4318   # OTLP HTTP receiver
          name: otlp-http
          protocol: TCP
        - containerPort: 14250  # Jaeger gRPC receiver
          name: jaeger-grpc
          protocol: TCP
        - containerPort: 14268  # Jaeger HTTP receiver
          name: jaeger-http
          protocol: TCP
        - containerPort: 6831   # Jaeger Thrift Compact
          name: jaeger-compact
          protocol: UDP
        - containerPort: 6832   # Jaeger Thrift Binary
          name: jaeger-binary
          protocol: UDP
        - containerPort: 9411   # Zipkin receiver
          name: zipkin
          protocol: TCP
        - containerPort: 8888   # Metrics
          name: metrics
          protocol: TCP
        - containerPort: 8889   # Prometheus metrics export
          name: prometheus
          protocol: TCP
        - containerPort: 13133  # Health check
          name: health
          protocol: TCP
        - containerPort: 1777   # pprof
          name: pprof
          protocol: TCP
        - containerPort: 55679  # zpages
          name: zpages
          protocol: TCP
        env:
        - name: K8S_NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: KUBE_NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        resources:
          requests:
            cpu: 200m
            memory: 512Mi
          limits:
            cpu: 1000m
            memory: 2Gi
        volumeMounts:
        - name: config
          mountPath: /conf
        - name: varlogpods
          mountPath: /var/log/pods
          readOnly: true
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
        livenessProbe:
          httpGet:
            path: /
            port: 13133
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /
            port: 13133
          initialDelaySeconds: 5
          periodSeconds: 10
      volumes:
      - name: config
        configMap:
          name: otel-collector-config
      - name: varlogpods
        hostPath:
          path: /var/log/pods
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
      hostNetwork: false
      dnsPolicy: ClusterFirst
---
apiVersion: v1
kind: Service
metadata:
  name: otel-collector
  namespace: example-monitoring
  labels:
    app: otel-collector
    component: monitoring
spec:
  type: ClusterIP
  ports:
  - port: 4317
    targetPort: 4317
    name: otlp-grpc
  - port: 4318
    targetPort: 4318
    name: otlp-http
  - port: 14250
    targetPort: 14250
    name: jaeger-grpc
  - port: 14268
    targetPort: 14268
    name: jaeger-http
  - port: 6831
    targetPort: 6831
    name: jaeger-compact
    protocol: UDP
  - port: 6832
    targetPort: 6832
    name: jaeger-binary
    protocol: UDP
  - port: 9411
    targetPort: 9411
    name: zipkin
  - port: 8889
    targetPort: 8889
    name: prometheus
  - port: 8888
    targetPort: 8888
    name: metrics
  selector:
    app: otel-collector
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: otel-collector
  namespace: example-monitoring
  labels:
    app: otel-collector
    component: monitoring
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: otel-collector
  labels:
    app: otel-collector
    component: monitoring
rules:
- apiGroups: [""]
  resources: ["nodes", "nodes/proxy", "nodes/metrics", "services", "endpoints", "pods", "events", "namespaces"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments", "daemonsets", "replicasets", "statefulsets"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["extensions"]
  resources: ["ingresses"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["networking.k8s.io"]
  resources: ["ingresses"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["batch"]
  resources: ["jobs", "cronjobs"]
  verbs: ["get", "list", "watch"]
- nonResourceURLs: ["/metrics", "/metrics/cadvisor"]
  verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: otel-collector
  labels:
    app: otel-collector
    component: monitoring
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: otel-collector
subjects:
- kind: ServiceAccount
  name: otel-collector
  namespace: example-monitoring