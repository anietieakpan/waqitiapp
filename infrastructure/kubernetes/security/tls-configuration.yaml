# TLS Configuration for Kubernetes
# This file configures SSL/TLS for all Waqiti services in Kubernetes

apiVersion: v1
kind: Namespace
metadata:
  name: waqiti-security
  labels:
    name: waqiti-security
    app.kubernetes.io/name: waqiti
    app.kubernetes.io/component: security

---
# Certificate Issuer for Let's Encrypt (Production)
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
  namespace: waqiti-security
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: security@example.com
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
    - http01:
        ingress:
          class: nginx
          podTemplate:
            spec:
              securityContext:
                runAsNonRoot: true
                runAsUser: 65534
                fsGroup: 65534
    - dns01:
        cloudflare:
          email: devops@example.com
          apiTokenSecretRef:
            name: cloudflare-api-token
            key: api-token

---
# Certificate Issuer for Let's Encrypt (Staging)
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging
  namespace: waqiti-security
spec:
  acme:
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    email: security@example.com
    privateKeySecretRef:
      name: letsencrypt-staging
    solvers:
    - http01:
        ingress:
          class: nginx
    - dns01:
        cloudflare:
          email: devops@example.com
          apiTokenSecretRef:
            name: cloudflare-api-token
            key: api-token

---
# Self-signed Certificate Issuer for Internal Services
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: selfsigned-issuer
  namespace: waqiti-security
spec:
  selfSigned: {}

---
# Internal CA Certificate for Service-to-Service Communication
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: waqiti-internal-ca
  namespace: waqiti-security
spec:
  isCA: true
  commonName: Waqiti Internal CA
  duration: 8760h # 1 year
  renewBefore: 360h # 15 days
  subject:
    organizationalUnits:
      - "Waqiti Security"
    organizations:
      - "Waqiti Inc"
    countries:
      - "US"
    provinces:
      - "California"
    localities:
      - "San Francisco"
  secretName: waqiti-internal-ca-secret
  privateKey:
    algorithm: RSA
    size: 4096
  issuerRef:
    name: selfsigned-issuer
    kind: ClusterIssuer

---
# Internal CA Issuer
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: waqiti-internal-ca-issuer
  namespace: waqiti-security
spec:
  ca:
    secretName: waqiti-internal-ca-secret

---
# Public Web Certificate for Frontend Applications
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: waqiti-web-tls
  namespace: waqiti-frontend
spec:
  secretName: waqiti-web-tls-secret
  duration: 2160h # 90 days
  renewBefore: 720h # 30 days
  subject:
    organizations:
      - "Waqiti Inc"
  commonName: app.example.com
  dnsNames:
    - example.com
    - app.example.com
    - admin.example.com
    - www.example.com
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer

---
# API Gateway Certificate
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: waqiti-api-tls
  namespace: waqiti-backend
spec:
  secretName: waqiti-api-tls-secret
  duration: 2160h # 90 days
  renewBefore: 720h # 30 days
  subject:
    organizations:
      - "Waqiti Inc"
  commonName: api.example.com
  dnsNames:
    - api.example.com
    - gateway.example.com
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer

---
# Internal Service Certificates Template
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: waqiti-internal-services-tls
  namespace: waqiti-backend
spec:
  secretName: waqiti-internal-services-tls-secret
  duration: 8760h # 1 year
  renewBefore: 2160h # 90 days
  subject:
    organizations:
      - "Waqiti Inc"
    organizationalUnits:
      - "Internal Services"
  commonName: "*.waqiti-backend.svc.cluster.local"
  dnsNames:
    - "*.waqiti-backend.svc.cluster.local"
    - "*.waqiti-backend"
    - "user-service.waqiti-backend.svc.cluster.local"
    - "payment-service.waqiti-backend.svc.cluster.local"
    - "wallet-service.waqiti-backend.svc.cluster.local"
    - "crypto-service.waqiti-backend.svc.cluster.local"
    - "investment-service.waqiti-backend.svc.cluster.local"
    - "analytics-service.waqiti-backend.svc.cluster.local"
    - "compliance-service.waqiti-backend.svc.cluster.local"
    - "security-service.waqiti-backend.svc.cluster.local"
    - "audit-service.waqiti-backend.svc.cluster.local"
    - "notification-service.waqiti-backend.svc.cluster.local"
    - "kyc-service.waqiti-backend.svc.cluster.local"
    - "ledger-service.waqiti-backend.svc.cluster.local"
    - "reporting-service.waqiti-backend.svc.cluster.local"
    - "websocket-service.waqiti-backend.svc.cluster.local"
  usages:
    - digital signature
    - key encipherment
    - server auth
    - client auth
  issuerRef:
    name: waqiti-internal-ca-issuer
    kind: ClusterIssuer

---
# TLS Policy for Istio Service Mesh
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: waqiti-backend
spec:
  mtls:
    mode: STRICT

---
# Destination Rule for mTLS
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: waqiti-services-mtls
  namespace: waqiti-backend
spec:
  host: "*.waqiti-backend.svc.cluster.local"
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL

---
# Network Policy for TLS Enforcement
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: waqiti-tls-enforcement
  namespace: waqiti-backend
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: waqiti-frontend
    - namespaceSelector:
        matchLabels:
          name: waqiti-backend
    - namespaceSelector:
        matchLabels:
          name: istio-system
    ports:
    - protocol: TCP
      port: 8443
    - protocol: TCP
      port: 443
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: waqiti-backend
    - namespaceSelector:
        matchLabels:
          name: waqiti-data
    - namespaceSelector:
        matchLabels:
          name: istio-system
    ports:
    - protocol: TCP
      port: 8443
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 5432 # PostgreSQL
    - protocol: TCP
      port: 6379 # Redis
  - to: [] # Allow DNS
    ports:
    - protocol: UDP
      port: 53

---
# TLS Secret for Cloudflare API Token
apiVersion: v1
kind: Secret
metadata:
  name: cloudflare-api-token
  namespace: waqiti-security
type: Opaque
data:
  api-token: # Base64 encoded Cloudflare API token

---
# ConfigMap for TLS Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: tls-config
  namespace: waqiti-security
data:
  ssl-protocols: "TLSv1.2 TLSv1.3"
  ssl-ciphers: "ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384"
  ssl-prefer-server-ciphers: "off"
  ssl-session-timeout: "10m"
  ssl-session-cache: "shared:SSL:10m"
  ssl-session-tickets: "off"
  hsts-max-age: "31536000"
  hsts-include-subdomains: "true"
  hsts-preload: "true"

---
# Pod Security Policy for TLS Services
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: waqiti-tls-psp
  namespace: waqiti-security
spec:
  privileged: false
  allowPrivilegeEscalation: false
  requiredDropCapabilities:
    - ALL
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
    - 'downwardAPI'
    - 'persistentVolumeClaim'
  runAsUser:
    rule: 'MustRunAsNonRoot'
  seLinux:
    rule: 'RunAsAny'
  fsGroup:
    rule: 'RunAsAny'
  readOnlyRootFilesystem: true
  securityContext:
    runAsNonRoot: true
    runAsUser: 65534
    fsGroup: 65534

---
# Role for TLS Certificate Management
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: waqiti-security
  name: tls-certificate-manager
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["cert-manager.io"]
  resources: ["certificates", "certificaterequests", "issuers"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

---
# Service Account for TLS Management
apiVersion: v1
kind: ServiceAccount
metadata:
  name: tls-certificate-manager
  namespace: waqiti-security

---
# Role Binding for TLS Certificate Manager
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: tls-certificate-manager
  namespace: waqiti-security
subjects:
- kind: ServiceAccount
  name: tls-certificate-manager
  namespace: waqiti-security
roleRef:
  kind: Role
  name: tls-certificate-manager
  apiGroup: rbac.authorization.k8s.io

---
# Monitoring for Certificate Expiry
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: cert-manager-metrics
  namespace: waqiti-security
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: cert-manager
  endpoints:
  - port: http-metrics
    interval: 60s
    path: /metrics

---
# PrometheusRule for Certificate Alerts
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: certificate-expiry-alerts
  namespace: waqiti-security
spec:
  groups:
  - name: certificate-expiry
    rules:
    - alert: CertificateExpiringSoon
      expr: certmanager_certificate_expiration_timestamp_seconds - time() < 7*24*3600
      for: 1h
      labels:
        severity: warning
        service: tls
      annotations:
        summary: "Certificate {{ $labels.name }} expiring soon"
        description: "Certificate {{ $labels.name }} in namespace {{ $labels.namespace }} will expire in less than 7 days"
    
    - alert: CertificateExpired
      expr: certmanager_certificate_expiration_timestamp_seconds - time() <= 0
      for: 1m
      labels:
        severity: critical
        service: tls
      annotations:
        summary: "Certificate {{ $labels.name }} has expired"
        description: "Certificate {{ $labels.name }} in namespace {{ $labels.namespace }} has expired"