apiVersion: v1
kind: ServiceAccount
metadata:
  name: secret-rotation-sa
  namespace: waqiti-system
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/SecretRotationRole
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: secret-rotation-role
  namespace: waqiti-system
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "update", "patch"]
- apiGroups: ["external-secrets.io"]
  resources: ["externalsecrets"]
  verbs: ["get", "list", "update", "patch"]
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "delete"]
- apiGroups: ["apps"]
  resources: ["deployments", "statefulsets", "daemonsets"]
  verbs: ["get", "list", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: secret-rotation-binding
  namespace: waqiti-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: secret-rotation-role
subjects:
- kind: ServiceAccount
  name: secret-rotation-sa
  namespace: waqiti-system
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: secret-rotation-script
  namespace: waqiti-system
data:
  rotate-secrets.sh: |
    #!/bin/bash
    set -euo pipefail
    
    # Configuration
    VAULT_ADDR="${VAULT_ADDR:-https://vault.vault.svc.cluster.local:8200}"
    NAMESPACE="waqiti-system"
    
    # Colors for output
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    RED='\033[0;31m'
    NC='\033[0m'
    
    echo -e "${GREEN}Starting secret rotation process...${NC}"
    
    # Function to generate secure password
    generate_password() {
        openssl rand -base64 32
    }
    
    # Function to rotate a secret in Vault
    rotate_vault_secret() {
        local path=$1
        local key=$2
        local new_value=$3
        
        echo -e "${YELLOW}Rotating secret: ${path} -> ${key}${NC}"
        
        # Read current secret
        current_data=$(vault kv get -format=json "$path" | jq '.data.data')
        
        # Update with new value
        updated_data=$(echo "$current_data" | jq --arg key "$key" --arg val "$new_value" '.[$key] = $val')
        
        # Write back to Vault
        echo "$updated_data" | vault kv put "$path" -
        
        echo -e "${GREEN}✓ Rotated successfully${NC}"
    }
    
    # Function to trigger pod restart
    restart_deployment() {
        local deployment=$1
        
        echo -e "${YELLOW}Restarting deployment: ${deployment}${NC}"
        
        # Add annotation to force restart
        kubectl patch deployment "$deployment" -n "$NAMESPACE" \
          -p '{"spec":{"template":{"metadata":{"annotations":{"rotated":"'$(date +%s)'"}}}}}'
        
        echo -e "${GREEN}✓ Restart triggered${NC}"
    }
    
    # Function to force External Secret sync
    force_external_secret_sync() {
        local secret_name=$1
        
        echo -e "${YELLOW}Forcing sync for External Secret: ${secret_name}${NC}"
        
        kubectl annotate externalsecret "$secret_name" -n "$NAMESPACE" \
          force-sync=$(date +%s) --overwrite
        
        echo -e "${GREEN}✓ Sync triggered${NC}"
    }
    
    # Rotate database passwords
    echo -e "\n${GREEN}=== Rotating Database Passwords ===${NC}"
    
    SERVICES=(
        "ml-service"
        "event-sourcing-service"
        "recurring-payment-service"
        "payment-service"
        "wallet-service"
        "transaction-service"
        "user-service"
        "notification-service"
        "fraud-detection-service"
        "compliance-service"
        "kyc-service"
        "ledger-service"
        "rewards-service"
        "support-service"
        "merchant-payment-service"
        "real-time-analytics-service"
        "core-banking-service"
    )
    
    for service in "${SERVICES[@]}"; do
        new_password=$(generate_password)
        rotate_vault_secret "waqiti/${service}" "db-password" "$new_password"
        
        # Force External Secret to sync
        force_external_secret_sync "${service}-secrets" || true
        
        # Restart the service
        restart_deployment "$service" || true
        
        sleep 5  # Brief pause between rotations
    done
    
    # Rotate Redis passwords
    echo -e "\n${GREEN}=== Rotating Redis Passwords ===${NC}"
    
    # Rotate main Redis password
    new_redis_password=$(generate_password)
    rotate_vault_secret "waqiti/infrastructure/redis" "password" "$new_redis_password"
    force_external_secret_sync "redis-credentials"
    
    # Update Redis deployment with new password
    kubectl patch statefulset redis-master -n "$NAMESPACE" \
      -p '{"spec":{"template":{"metadata":{"annotations":{"rotated":"'$(date +%s)'"}}}}}'
    
    # Rotate JWT secrets
    echo -e "\n${GREEN}=== Rotating JWT Secrets ===${NC}"
    
    new_jwt_secret=$(openssl rand -base64 64)
    rotate_vault_secret "waqiti/auth" "jwt-secret" "$new_jwt_secret"
    force_external_secret_sync "jwt-secret"
    
    # Note: JWT rotation requires careful coordination
    echo -e "${YELLOW}Note: JWT secret rotated. Existing tokens will become invalid.${NC}"
    
    # Rotate encryption keys (with key versioning)
    echo -e "\n${GREEN}=== Rotating Encryption Keys ===${NC}"
    
    # Read current keys
    current_keys=$(vault kv get -format=json "waqiti/encryption" | jq '.data.data')
    
    # Archive current master key
    current_master=$(echo "$current_keys" | jq -r '.["master-key"]')
    archive_date=$(date +%Y%m%d-%H%M%S)
    
    # Create new master key
    new_master_key=$(openssl rand -base64 32)
    
    # Update with versioning
    vault kv put "waqiti/encryption" \
      master-key="$new_master_key" \
      data-key="$(echo "$current_keys" | jq -r '.["data-key"]')" \
      previous-master-key="$current_master" \
      rotation-date="$archive_date"
    
    force_external_secret_sync "encryption-keys"
    
    echo -e "${YELLOW}Note: Encryption keys rotated. Re-encryption of existing data may be required.${NC}"
    
    # Generate rotation report
    echo -e "\n${GREEN}=== Rotation Summary ===${NC}"
    echo "Rotation completed at: $(date)"
    echo "Rotated items:"
    echo "  - Database passwords: ${#SERVICES[@]} services"
    echo "  - Redis password: 1"
    echo "  - JWT secret: 1"
    echo "  - Encryption keys: 1"
    
    # Log rotation event
    kubectl create configmap "rotation-log-$(date +%Y%m%d-%H%M%S)" \
      -n "$NAMESPACE" \
      --from-literal=timestamp="$(date)" \
      --from-literal=rotated_by="secret-rotation-cronjob" \
      --from-literal=status="completed"
    
    echo -e "\n${GREEN}Secret rotation completed successfully!${NC}"

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: secret-rotation
  namespace: waqiti-system
spec:
  schedule: "0 2 1 * *"  # Run at 2 AM on the 1st of every month
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: secret-rotation-sa
          containers:
          - name: secret-rotator
            image: vault:1.15.4
            env:
            - name: VAULT_ADDR
              value: "https://vault.vault.svc.cluster.local:8200"
            - name: VAULT_CACERT
              value: "/vault/tls/ca.crt"
            - name: VAULT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: vault-rotation-token
                  key: token
            command: ["/bin/bash"]
            args: ["/scripts/rotate-secrets.sh"]
            volumeMounts:
            - name: scripts
              mountPath: /scripts
            - name: vault-tls
              mountPath: /vault/tls
            resources:
              requests:
                memory: "256Mi"
                cpu: "100m"
              limits:
                memory: "512Mi"
                cpu: "500m"
          volumes:
          - name: scripts
            configMap:
              name: secret-rotation-script
              defaultMode: 0755
          - name: vault-tls
            secret:
              secretName: vault-server-tls
          restartPolicy: OnFailure
---
# Manual rotation job (can be triggered on-demand)
apiVersion: batch/v1
kind: Job
metadata:
  name: manual-secret-rotation
  namespace: waqiti-system
  annotations:
    "helm.sh/hook": post-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  template:
    spec:
      serviceAccountName: secret-rotation-sa
      containers:
      - name: secret-rotator
        image: vault:1.15.4
        env:
        - name: VAULT_ADDR
          value: "https://vault.vault.svc.cluster.local:8200"
        - name: VAULT_CACERT
          value: "/vault/tls/ca.crt"
        - name: VAULT_TOKEN
          valueFrom:
            secretKeyRef:
              name: vault-rotation-token
              key: token
        command: ["/bin/bash"]
        args: ["/scripts/rotate-secrets.sh"]
        volumeMounts:
        - name: scripts
          mountPath: /scripts
        - name: vault-tls
          mountPath: /vault/tls
      volumes:
      - name: scripts
        configMap:
          name: secret-rotation-script
          defaultMode: 0755
      - name: vault-tls
        secret:
          secretName: vault-server-tls
      restartPolicy: Never
      backoffLimit: 3