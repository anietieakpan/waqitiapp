# CRITICAL SECURITY: Hardened Payment Service Deployment
# Implements comprehensive security controls for PCI-DSS compliance

apiVersion: apps/v1
kind: Deployment
metadata:
  name: payment-service
  namespace: waqiti
  labels:
    app: payment-service
    version: v1
    component: backend
    security: hardened
    compliance: pci-dss
  annotations:
    security.example.com/review-date: "2024-01-01"
    security.example.com/data-classification: "highly-sensitive"
spec:
  replicas: 3
  revisionHistoryLimit: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0  # Zero downtime deployment
  selector:
    matchLabels:
      app: payment-service
      version: v1
  template:
    metadata:
      labels:
        app: payment-service
        version: v1
        component: backend
        security: hardened
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
        prometheus.io/path: "/actuator/prometheus"
        prometheus.io/scheme: "https"
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/role: "payment-service"
        vault.hashicorp.com/agent-inject-secret-database: "database/creds/payment-service"
        container.apparmor.security.beta.kubernetes.io/payment-service: runtime/default
        seccomp.security.alpha.kubernetes.io/pod: runtime/default
    spec:
      # CRITICAL: Service account with minimal permissions
      serviceAccountName: payment-service-sa
      automountServiceAccountToken: false
      
      # CRITICAL: Pod-level security context
      securityContext:
        runAsNonRoot: true
        runAsUser: 10001
        runAsGroup: 10001
        fsGroup: 10001
        fsGroupChangePolicy: "OnRootMismatch"
        seccompProfile:
          type: RuntimeDefault
        supplementalGroups: [10001]
      
      # Security settings
      hostNetwork: false
      hostPID: false
      hostIPC: false
      dnsPolicy: ClusterFirst
      
      initContainers:
      # Security scanner init container
      - name: security-scanner
        image: waqiti/security-scanner:latest
        imagePullPolicy: Always
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "Running security checks..."
          # Scan for vulnerabilities
          /usr/local/bin/trivy fs --no-progress --exit-code 1 --severity HIGH,CRITICAL /app || exit 1
          # Verify file permissions
          find /app -type f -perm /077 -exec chmod 600 {} \;
          find /app -type d -perm /077 -exec chmod 700 {} \;
          echo "Security scan complete"
        securityContext:
          runAsNonRoot: true
          runAsUser: 10001
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop: ["ALL"]
        resources:
          limits:
            memory: "256Mi"
            cpu: "200m"
      
      # Dependency check
      - name: wait-for-dependencies
        image: busybox:1.35
        imagePullPolicy: IfNotPresent
        command: ['sh', '-c']
        args:
        - |
          until nc -z postgres 5432 && nc -z kafka-0.kafka 9092 && nc -z redis-master 6379; do
            echo "Waiting for dependencies..."
            sleep 2
          done
          echo "All dependencies ready"
        securityContext:
          runAsNonRoot: true
          runAsUser: 10001
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop: ["ALL"]
            add: ["NET_RAW"]  # Required for nc
        resources:
          limits:
            memory: "64Mi"
            cpu: "50m"
      
      containers:
      - name: payment-service
        image: waqiti/payment-service:v1.0.0
        imagePullPolicy: Always
        
        # CRITICAL: Container security context
        securityContext:
          runAsNonRoot: true
          runAsUser: 10001
          runAsGroup: 10001
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop: ["ALL"]
          seccompProfile:
            type: RuntimeDefault
        
        ports:
        - containerPort: 8080
          name: https
          protocol: TCP
        - containerPort: 9090
          name: metrics
          protocol: TCP
        
        # Environment variables (no secrets here)
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "kubernetes,secure,production"
        - name: JAVA_OPTS
          value: "-Xms512m -Xmx1g -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -Djava.security.egd=file:/dev/./urandom -Duser.timezone=UTC"
        - name: SERVER_PORT
          value: "8080"
        - name: SERVER_SSL_ENABLED
          value: "true"
        - name: SERVER_SSL_KEY_STORE
          value: "/app/certs/keystore.p12"
        - name: SERVER_SSL_KEY_STORE_TYPE
          value: "PKCS12"
        - name: MANAGEMENT_SERVER_PORT
          value: "9090"
        - name: MANAGEMENT_SERVER_SSL_ENABLED
          value: "true"
        - name: SPRING_DATASOURCE_URL
          value: "jdbc:postgresql://postgres:5432/payment_db?sslmode=require&sslcert=/app/certs/client.crt&sslkey=/app/certs/client.key"
        - name: SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE
          value: "10"
        - name: SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE
          value: "5"
        - name: SPRING_KAFKA_BOOTSTRAP_SERVERS
          value: "kafka-0.kafka:9092,kafka-1.kafka:9092,kafka-2.kafka:9092"
        - name: SPRING_KAFKA_SSL_ENABLED
          value: "true"
        - name: SPRING_REDIS_HOST
          value: "redis-master"
        - name: SPRING_REDIS_PORT
          value: "6379"
        - name: SPRING_REDIS_SSL
          value: "true"
        - name: EUREKA_CLIENT_SERVICE_URL_DEFAULT_ZONE
          value: "https://discovery-service:8761/eureka/"
        - name: SPRING_CLOUD_CONFIG_URI
          value: "https://config-service:8888"
        - name: VAULT_ADDR
          value: "https://vault:8200"
        - name: JAEGER_AGENT_HOST
          value: "jaeger-agent"
        - name: JAEGER_AGENT_PORT
          value: "6831"
        - name: SECURITY_REQUIRE_SSL
          value: "true"
        - name: SECURITY_HEADERS_ENABLED
          value: "true"
        - name: RATE_LIMITING_ENABLED
          value: "true"
        - name: AUDIT_LOGGING_ENABLED
          value: "true"
        
        # Secrets from volumes (not env vars)
        envFrom:
        - secretRef:
            name: payment-service-env-secrets
            optional: false
        
        # Resource limits
        resources:
          requests:
            memory: "768Mi"
            cpu: "500m"
            ephemeral-storage: "1Gi"
          limits:
            memory: "1536Mi"
            cpu: "1500m"
            ephemeral-storage: "2Gi"
        
        # Health checks with HTTPS
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 9090
            scheme: HTTPS
          initialDelaySeconds: 90
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1
        
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 9090
            scheme: HTTPS
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1
        
        startupProbe:
          httpGet:
            path: /actuator/health/startup
            port: 9090
            scheme: HTTPS
          initialDelaySeconds: 0
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 30
          successThreshold: 1
        
        # Volume mounts
        volumeMounts:
        - name: config
          mountPath: /app/config
          readOnly: true
        - name: payment-keys
          mountPath: /app/keys
          readOnly: true
        - name: certs
          mountPath: /app/certs
          readOnly: true
        - name: tmp
          mountPath: /tmp
        - name: app-cache
          mountPath: /app/cache
        - name: app-logs
          mountPath: /var/log/app
      
      # Sidecar: Security monitoring
      - name: security-monitor
        image: waqiti/security-monitor:latest
        imagePullPolicy: Always
        securityContext:
          runAsNonRoot: true
          runAsUser: 10002
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop: ["ALL"]
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        volumeMounts:
        - name: app-logs
          mountPath: /var/log/app
          readOnly: true
        env:
        - name: SERVICE_NAME
          value: "payment-service"
        - name: LOG_LEVEL
          value: "info"
      
      # Volumes
      volumes:
      - name: config
        configMap:
          name: payment-service-config
          defaultMode: 0400
      - name: payment-keys
        secret:
          secretName: payment-encryption-keys
          defaultMode: 0400
      - name: certs
        secret:
          secretName: payment-service-certs
          defaultMode: 0400
      - name: tmp
        emptyDir:
          sizeLimit: 100Mi
          medium: Memory
      - name: app-cache
        emptyDir:
          sizeLimit: 500Mi
      - name: app-logs
        emptyDir:
          sizeLimit: 1Gi
      
      # Image pull secrets
      imagePullSecrets:
      - name: registry-credentials
      
      # Node selection
      nodeSelector:
        kubernetes.io/os: linux
        workload: payment
      
      # Tolerations for dedicated nodes
      tolerations:
      - key: "workload"
        operator: "Equal"
        value: "payment"
        effect: "NoSchedule"
      
      # Pod affinity/anti-affinity
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - payment-service
            topologyKey: kubernetes.io/hostname
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: node-type
                operator: In
                values:
                - secure
                - payment-processing
      
      # Priority class
      priorityClassName: critical-priority
      
      # Termination settings
      terminationGracePeriodSeconds: 60
      
      # DNS configuration
      dnsConfig:
        options:
        - name: ndots
          value: "2"
        - name: edns0

---
# ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: payment-service-sa
  namespace: waqiti
  labels:
    app: payment-service
automountServiceAccountToken: false

---
# Role with minimal permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: payment-service-role
  namespace: waqiti
rules:
- apiGroups: [""]
  resources: ["configmaps"]
  resourceNames: ["payment-service-config"]
  verbs: ["get", "watch"]
- apiGroups: [""]
  resources: ["secrets"]
  resourceNames: ["payment-encryption-keys", "payment-service-certs", "payment-service-env-secrets"]
  verbs: ["get"]

---
# RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: payment-service-rolebinding
  namespace: waqiti
subjects:
- kind: ServiceAccount
  name: payment-service-sa
  namespace: waqiti
roleRef:
  kind: Role
  name: payment-service-role
  apiGroup: rbac.authorization.k8s.io

---
# PriorityClass for critical services
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: critical-priority
value: 1000
globalDefault: false
description: "Priority class for critical payment services"

---
# PodDisruptionBudget
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: payment-service-pdb
  namespace: waqiti
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: payment-service