apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-config
  namespace: vault-system
data:
  vault.hcl: |
    # Vault Configuration for Waqiti Banking Platform

    ui = true

    # Listener for Vault API (HTTPS)
    listener "tcp" {
      address       = "0.0.0.0:8200"
      tls_cert_file = "/vault/tls/tls.crt"
      tls_key_file  = "/vault/tls/tls.key"

      # Security hardening
      tls_min_version = "tls12"
      tls_cipher_suites = "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"
    }

    # High Availability Backend (Raft)
    storage "raft" {
      path = "/vault/data"

      node_id = "VAULT_NODE_ID"

      retry_join {
        leader_api_addr = "https://vault-0.vault-internal:8200"
      }

      retry_join {
        leader_api_addr = "https://vault-1.vault-internal:8200"
      }

      retry_join {
        leader_api_addr = "https://vault-2.vault-internal:8200"
      }

      autopilot {
        cleanup_dead_servers = true
        last_contact_threshold = "10s"
        max_trailing_logs = 1000
        min_quorum = 2
      }
    }

    # Cloud auto-unseal (AWS KMS)
    seal "awskms" {
      region     = "us-east-1"
      kms_key_id = "VAULT_KMS_KEY_ID"
      endpoint   = "https://kms.us-east-1.amazonaws.com"
    }

    # Telemetry
    telemetry {
      prometheus_retention_time = "30s"
      disable_hostname = false
      unauthenticated_metrics_access = true
    }

    # API settings
    api_addr = "https://VAULT_POD_NAME.vault-internal:8200"
    cluster_addr = "https://VAULT_POD_NAME.vault-internal:8201"

    # Disable mlock (for Kubernetes)
    disable_mlock = true

    # Log level
    log_level = "info"
    log_format = "json"
