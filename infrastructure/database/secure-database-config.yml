# Secure Database Configuration with SSL/TLS Encryption
# Implements database connection encryption for all services
# Ensures data protection in transit between application and database

# PostgreSQL SSL Configuration
postgresql:
  ssl:
    enabled: true
    mode: require  # Options: disable, allow, prefer, require, verify-ca, verify-full
    
    # Certificate Configuration
    certificates:
      # Server Certificate Authority
      ca-cert: /etc/ssl/certs/postgresql-ca.crt
      
      # Client Certificate (for mutual TLS)
      client-cert: /etc/ssl/certs/postgresql-client.crt
      client-key: /etc/ssl/private/postgresql-client.key
      
      # Certificate validation
      verify-hostname: true
      verify-ca: true
    
    # SSL Protocol Configuration
    protocols:
      min-version: TLSv1.2
      max-version: TLSv1.3
      cipher-suites:
        - TLS_AES_256_GCM_SHA384
        - TLS_AES_128_GCM_SHA256
        - TLS_CHACHA20_POLY1305_SHA256
        - ECDHE-RSA-AES256-GCM-SHA384
        - ECDHE-RSA-AES128-GCM-SHA256
    
    # Connection Pool SSL Settings
    pool:
      ssl-factory: org.postgresql.ssl.PGSSLSocketFactory
      ssl-factory-arg: "&sslmode=require&sslcert=/etc/ssl/certs/client.crt&sslkey=/etc/ssl/private/client.key&sslrootcert=/etc/ssl/certs/ca.crt"

# Spring Boot DataSource Configuration
spring:
  datasource:
    # Primary DataSource with SSL
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:waqiti}?sslmode=require&sslcert=/etc/ssl/certs/client.crt&sslkey=/etc/ssl/private/client.key&sslrootcert=/etc/ssl/certs/ca.crt&sslfactory=org.postgresql.ssl.PGSSLSocketFactory
    
    # Connection Properties
    connection-properties: |
      ssl=true
      sslmode=require
      sslcert=/etc/ssl/certs/postgresql-client.crt
      sslkey=/etc/ssl/private/postgresql-client.key
      sslrootcert=/etc/ssl/certs/postgresql-ca.crt
      sslfactory=org.postgresql.ssl.PGSSLSocketFactory
      sslcompression=0
      sendBufferSize=0
      receiveBufferSize=0
      loggerLevel=OFF
      
    # HikariCP Configuration with SSL
    hikari:
      data-source-properties:
        ssl: true
        sslmode: require
        sslcert: /etc/ssl/certs/postgresql-client.crt
        sslkey: /etc/ssl/private/postgresql-client.key
        sslrootcert: /etc/ssl/certs/postgresql-ca.crt
        sslfactory: org.postgresql.ssl.PGSSLSocketFactory
        sslcompression: 0
        
      # Connection pool settings
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      
      # SSL validation
      connection-test-query: SELECT 1
      validation-timeout: 5000

# MongoDB SSL Configuration
mongodb:
  uri: mongodb://${MONGO_HOST:localhost}:${MONGO_PORT:27017}/${MONGO_DB:waqiti}?ssl=true&sslInvalidHostNameAllowed=false&sslInvalidCertificateAllowed=false
  
  ssl:
    enabled: true
    
    # Certificate Configuration
    keyStore: /etc/ssl/keystores/mongodb-keystore.jks
    keyStorePassword: ${vault:secret/mongodb/keystore-password}
    keyStoreType: JKS
    
    trustStore: /etc/ssl/keystores/mongodb-truststore.jks
    trustStorePassword: ${vault:secret/mongodb/truststore-password}
    trustStoreType: JKS
    
    # SSL Protocol Settings
    protocol: TLS
    enabled-protocols:
      - TLSv1.2
      - TLSv1.3

# Redis SSL Configuration
redis:
  ssl:
    enabled: true
    
    # Certificate Configuration
    keyStore: /etc/ssl/keystores/redis-keystore.jks
    keyStorePassword: ${vault:secret/redis/keystore-password}
    keyStoreType: JKS
    
    trustStore: /etc/ssl/keystores/redis-truststore.jks
    trustStorePassword: ${vault:secret/redis/truststore-password}
    trustStoreType: JKS
    
    # Protocol Configuration
    protocols:
      - TLSv1.2
      - TLSv1.3
    
    # Cipher Suites
    cipherSuites:
      - TLS_AES_256_GCM_SHA384
      - TLS_AES_128_GCM_SHA256

# Elasticsearch SSL Configuration
elasticsearch:
  ssl:
    enabled: true
    
    # Certificate Configuration
    keystore:
      path: /etc/elasticsearch/certs/elastic-keystore.p12
      password: ${vault:secret/elasticsearch/keystore-password}
      type: PKCS12
    
    truststore:
      path: /etc/elasticsearch/certs/elastic-truststore.p12
      password: ${vault:secret/elasticsearch/truststore-password}
      type: PKCS12
    
    # Verification Mode
    verification-mode: certificate
    
    # Supported Protocols
    supported-protocols:
      - TLSv1.2
      - TLSv1.3

# Cassandra SSL Configuration
cassandra:
  ssl:
    enabled: true
    
    # SSL Context
    context:
      protocol: TLS
      keystore:
        path: /etc/cassandra/certs/cassandra-keystore.jks
        password: ${vault:secret/cassandra/keystore-password}
        type: JKS
      
      truststore:
        path: /etc/cassandra/certs/cassandra-truststore.jks
        password: ${vault:secret/cassandra/truststore-password}
        type: JKS
    
    # Cipher Suites
    cipher-suites:
      - TLS_RSA_WITH_AES_128_CBC_SHA
      - TLS_RSA_WITH_AES_256_CBC_SHA

# MySQL/MariaDB SSL Configuration
mysql:
  ssl:
    enabled: true
    
    # Connection String Parameters
    connection-params: |
      useSSL=true
      requireSSL=true
      verifyServerCertificate=true
      trustCertificateKeyStoreUrl=file:///etc/ssl/keystores/mysql-truststore.jks
      trustCertificateKeyStorePassword=${vault:secret/mysql/truststore-password}
      clientCertificateKeyStoreUrl=file:///etc/ssl/keystores/mysql-keystore.jks
      clientCertificateKeyStorePassword=${vault:secret/mysql/keystore-password}
      enabledTLSProtocols=TLSv1.2,TLSv1.3

# Connection Pool Monitoring
monitoring:
  database:
    ssl:
      # Monitor SSL handshake performance
      handshake-timeout: 5000
      
      # Certificate expiry monitoring
      certificate-expiry-warning-days: 30
      
      # Connection encryption validation
      validate-encryption: true
      validation-interval: 300000  # 5 minutes
      
      # Metrics collection
      metrics:
        enabled: true
        export-to-prometheus: true
        tags:
          - ssl_enabled
          - protocol_version
          - cipher_suite

# Security Policies
security:
  database:
    # Enforce SSL for all connections
    require-ssl: true
    
    # Reject non-SSL connections
    reject-plain-connections: true
    
    # Certificate rotation
    certificate-rotation:
      enabled: true
      check-interval: 86400000  # 24 hours
      auto-rotate: true
      rotation-warning-days: 7
    
    # Audit SSL connections
    audit:
      log-ssl-connections: true
      log-ssl-failures: true
      log-certificate-details: true

# Environment-Specific Overrides
environments:
  development:
    postgresql:
      ssl:
        mode: prefer
        verify-ca: false
    
  staging:
    postgresql:
      ssl:
        mode: require
        verify-ca: true
    
  production:
    postgresql:
      ssl:
        mode: verify-full
        verify-ca: true
        verify-hostname: true

# Certificate Management
certificates:
  # Auto-renewal configuration
  auto-renewal:
    enabled: true
    days-before-expiry: 30
    renewal-command: /scripts/renew-db-certificates.sh
  
  # Storage locations
  storage:
    base-path: /etc/ssl
    certificates-dir: certs
    private-keys-dir: private
    keystores-dir: keystores
  
  # Permissions
  permissions:
    certificates: "0644"
    private-keys: "0600"
    keystores: "0600"

# Troubleshooting
debug:
  ssl:
    enabled: false  # Enable for SSL debugging
    system-properties:
      - javax.net.debug=ssl:handshake
      - javax.net.ssl.trustStore=/etc/ssl/keystores/truststore.jks
      - javax.net.ssl.keyStore=/etc/ssl/keystores/keystore.jks