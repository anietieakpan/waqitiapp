version: '3.8'

services:
  # PostgreSQL Database - Production Configuration
  postgres:
    image: postgres:15.4-alpine
    container_name: waqiti-postgres-staging
    environment:
      - POSTGRES_DB=waqiti_staging
      - POSTGRES_USER=${POSTGRES_USER:-waqiti_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_INITDB_ARGS=--data-checksums
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres-staging-data:/var/lib/postgresql/data
      - ./postgres/init-scripts:/docker-entrypoint-initdb.d:ro
      - ./postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
    ports:
      - "5432:5432"
    networks:
      - waqiti-staging-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.5'
        reservations:
          memory: 1G
          cpus: '0.5'
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-waqiti_user} -d waqiti_staging"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache - Production Configuration
  redis:
    image: redis:7.2-alpine
    container_name: waqiti-redis-staging
    environment:
      - REDIS_REPLICATION_MODE=master
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    volumes:
      - redis-staging-data:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    ports:
      - "6379:6379"
    networks:
      - waqiti-staging-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
          cpus: '0.2'
    command: redis-server /usr/local/etc/redis/redis.conf --requirepass ${REDIS_PASSWORD}
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Apache Kafka - Event Streaming
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: waqiti-zookeeper-staging
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_SYNC_LIMIT: 2
      ZOOKEEPER_INIT_LIMIT: 5
      ZOOKEEPER_MAX_CLIENT_CNXNS: 60
      ZOOKEEPER_AUTOPURGE_SNAP_RETAIN_COUNT: 3
      ZOOKEEPER_AUTOPURGE_PURGE_INTERVAL: 24
    volumes:
      - zookeeper-staging-data:/var/lib/zookeeper/data
      - zookeeper-staging-logs:/var/lib/zookeeper/log
    networks:
      - waqiti-staging-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: waqiti-kafka-staging
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 100
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_LOG_RETENTION_BYTES: 1073741824
      KAFKA_LOG_SEGMENT_BYTES: 1073741824
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: false
      KAFKA_JMX_PORT: 9999
      KAFKA_JMX_HOSTNAME: localhost
    volumes:
      - kafka-staging-data:/var/lib/kafka/data
    ports:
      - "29092:29092"
      - "9999:9999"
    networks:
      - waqiti-staging-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1'
        reservations:
          memory: 512M
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 10s
      retries: 5

  # Payment Service
  payment-service:
    image: waqiti/payment-service:${IMAGE_TAG:-latest}
    container_name: waqiti-payment-service-staging
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    environment:
      # Database Configuration
      - SPRING_PROFILES_ACTIVE=staging
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/waqiti_staging
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER:-waqiti_user}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD}
      - SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE=20
      - SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE=5
      
      # Redis Configuration
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - SPRING_REDIS_PASSWORD=${REDIS_PASSWORD}
      - SPRING_REDIS_TIMEOUT=5000ms
      - SPRING_REDIS_LETTUCE_POOL_MAX_ACTIVE=20
      - SPRING_REDIS_LETTUCE_POOL_MAX_IDLE=10
      
      # Kafka Configuration
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - SPRING_KAFKA_PRODUCER_RETRIES=3
      - SPRING_KAFKA_PRODUCER_ACKS=all
      - SPRING_KAFKA_PRODUCER_ENABLE_IDEMPOTENCE=true
      - SPRING_KAFKA_CONSUMER_GROUP_ID=payment-service-staging
      - SPRING_KAFKA_CONSUMER_AUTO_OFFSET_RESET=earliest
      
      # Security Configuration
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRATION=86400000
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      
      # External Service Configuration
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - PAYPAL_CLIENT_ID=${PAYPAL_CLIENT_ID}
      - PAYPAL_CLIENT_SECRET=${PAYPAL_CLIENT_SECRET}
      - FLUTTERWAVE_SECRET_KEY=${FLUTTERWAVE_SECRET_KEY}
      - PAYSTACK_SECRET_KEY=${PAYSTACK_SECRET_KEY}
      
      # Monitoring Configuration
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,metrics,prometheus
      - MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS=always
      - MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED=true
      
      # Performance Configuration
      - SERVER_TOMCAT_MAX_THREADS=200
      - SERVER_TOMCAT_MAX_CONNECTIONS=8192
      - SERVER_TOMCAT_ACCEPT_COUNT=100
      - SPRING_JPA_HIBERNATE_DDL_AUTO=validate
      - SPRING_JPA_SHOW_SQL=false
      - SPRING_JPA_PROPERTIES_HIBERNATE_JDBC_BATCH_SIZE=20
      
      # Logging Configuration
      - LOGGING_LEVEL_ROOT=INFO
      - LOGGING_LEVEL_COM_WAQITI=INFO
      - LOGGING_PATTERN_CONSOLE=%d{HH:mm:ss.SSS} [%thread] %-5level [%X{traceId:-},%X{spanId:-}] %logger{36} - %msg%n
      
    ports:
      - "8081:8080"
    networks:
      - waqiti-staging-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1'
        reservations:
          memory: 1G
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.payment-service.rule=Host(`payment-staging.example.com`)"
      - "traefik.http.routers.payment-service.entrypoints=websecure"
      - "traefik.http.routers.payment-service.tls.certresolver=letsencrypt"

  # Wallet Service
  wallet-service:
    image: waqiti/wallet-service:${IMAGE_TAG:-latest}
    container_name: waqiti-wallet-service-staging
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    environment:
      # Database Configuration
      - SPRING_PROFILES_ACTIVE=staging
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/waqiti_staging
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER:-waqiti_user}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD}
      - SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE=20
      - SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE=5
      
      # Redis Configuration
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - SPRING_REDIS_PASSWORD=${REDIS_PASSWORD}
      - SPRING_REDIS_TIMEOUT=5000ms
      - SPRING_REDIS_LETTUCE_POOL_MAX_ACTIVE=20
      - SPRING_REDIS_LETTUCE_POOL_MAX_IDLE=10
      
      # Kafka Configuration
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - SPRING_KAFKA_PRODUCER_RETRIES=3
      - SPRING_KAFKA_PRODUCER_ACKS=all
      - SPRING_KAFKA_PRODUCER_ENABLE_IDEMPOTENCE=true
      - SPRING_KAFKA_CONSUMER_GROUP_ID=wallet-service-staging
      
      # Security Configuration
      - JWT_SECRET=${JWT_SECRET}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      
      # Currency Exchange Configuration
      - EXCHANGE_RATE_API_KEY=${EXCHANGE_RATE_API_KEY}
      - EXCHANGE_RATE_PROVIDER=currencylayer
      
      # Wallet Configuration
      - WALLET_DAILY_TRANSACTION_LIMIT=50000.00
      - WALLET_SINGLE_TRANSACTION_LIMIT=10000.00
      - WALLET_MINIMUM_BALANCE=0.00
      - WALLET_OVERDRAFT_PROTECTION=true
      
      # Monitoring and Performance
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,metrics,prometheus
      - MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS=always
      - MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED=true
      - SERVER_TOMCAT_MAX_THREADS=200
      - SPRING_JPA_HIBERNATE_DDL_AUTO=validate
      - LOGGING_LEVEL_ROOT=INFO
      - LOGGING_LEVEL_COM_WAQITI=INFO
      
    ports:
      - "8082:8080"
    networks:
      - waqiti-staging-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1'
        reservations:
          memory: 1G
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.wallet-service.rule=Host(`wallet-staging.example.com`)"
      - "traefik.http.routers.wallet-service.entrypoints=websecure"
      - "traefik.http.routers.wallet-service.tls.certresolver=letsencrypt"

  # Fraud Detection Service
  fraud-detection-service:
    image: waqiti/fraud-detection-service:${IMAGE_TAG:-latest}
    container_name: waqiti-fraud-detection-service-staging
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    environment:
      # Database Configuration
      - SPRING_PROFILES_ACTIVE=staging
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/waqiti_staging
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER:-waqiti_user}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD}
      - SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE=15
      
      # Redis Configuration
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - SPRING_REDIS_PASSWORD=${REDIS_PASSWORD}
      
      # Kafka Configuration
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - SPRING_KAFKA_CONSUMER_GROUP_ID=fraud-detection-staging
      
      # ML Model Configuration
      - ML_MODEL_PATH=/app/models/fraud-detection-model-v2.pkl
      - ML_MODEL_THRESHOLD=0.7
      - ML_MODEL_CONFIDENCE_THRESHOLD=0.85
      - ML_FEATURE_SCALING_ENABLED=true
      
      # Fraud Detection Configuration
      - FRAUD_VELOCITY_WINDOW_MINUTES=60
      - FRAUD_VELOCITY_TRANSACTION_LIMIT=10
      - FRAUD_VELOCITY_AMOUNT_LIMIT=5000.00
      - FRAUD_HIGH_RISK_COUNTRIES=AF,BY,CF,CG,CI,CU,CD,ER,GN,HT,IR,IQ,KP,LB,LR,LY,ML,MM,NI,SO,SS,SD,SY,VE,YE,ZW
      - FRAUD_SANCTIONS_CHECK_ENABLED=true
      - FRAUD_DEVICE_FINGERPRINT_ENABLED=true
      - FRAUD_IP_GEOLOCATION_ENABLED=true
      
      # Security Configuration
      - JWT_SECRET=${JWT_SECRET}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      
      # External Services
      - SANCTIONS_API_URL=${SANCTIONS_API_URL}
      - SANCTIONS_API_KEY=${SANCTIONS_API_KEY}
      - GEOLOCATION_API_URL=${GEOLOCATION_API_URL}
      - GEOLOCATION_API_KEY=${GEOLOCATION_API_KEY}
      
      # Performance and Monitoring
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,metrics,prometheus
      - MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS=always
      - MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED=true
      - SERVER_TOMCAT_MAX_THREADS=150
      - SPRING_JPA_HIBERNATE_DDL_AUTO=validate
      - LOGGING_LEVEL_ROOT=INFO
      - LOGGING_LEVEL_COM_WAQITI=DEBUG
      
    ports:
      - "8083:8080"
    networks:
      - waqiti-staging-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1'
        reservations:
          memory: 1G
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.fraud-service.rule=Host(`fraud-staging.example.com`)"
      - "traefik.http.routers.fraud-service.entrypoints=websecure"
      - "traefik.http.routers.fraud-service.tls.certresolver=letsencrypt"

  # Reconciliation Service
  reconciliation-service:
    image: waqiti/reconciliation-service:${IMAGE_TAG:-latest}
    container_name: waqiti-reconciliation-service-staging
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    environment:
      # Database Configuration
      - SPRING_PROFILES_ACTIVE=staging
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/waqiti_staging
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER:-waqiti_user}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD}
      
      # Redis Configuration
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - SPRING_REDIS_PASSWORD=${REDIS_PASSWORD}
      
      # Kafka Configuration
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - SPRING_KAFKA_CONSUMER_GROUP_ID=reconciliation-service-staging
      
      # Reconciliation Configuration
      - RECONCILIATION_SCHEDULE_ENABLED=true
      - RECONCILIATION_DAILY_SCHEDULE=0 2 * * *
      - RECONCILIATION_REAL_TIME_ENABLED=true
      - RECONCILIATION_TOLERANCE_AMOUNT=0.01
      - RECONCILIATION_AUTO_RESOLVE_ENABLED=false
      - RECONCILIATION_NOTIFICATION_ENABLED=true
      
      # Provider Configuration
      - PROVIDER_STRIPE_RECONCILIATION_ENABLED=true
      - PROVIDER_PAYPAL_RECONCILIATION_ENABLED=true
      - PROVIDER_FLUTTERWAVE_RECONCILIATION_ENABLED=true
      - PROVIDER_PAYSTACK_RECONCILIATION_ENABLED=true
      
      # Security Configuration
      - JWT_SECRET=${JWT_SECRET}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      
      # External Provider APIs
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - PAYPAL_CLIENT_ID=${PAYPAL_CLIENT_ID}
      - PAYPAL_CLIENT_SECRET=${PAYPAL_CLIENT_SECRET}
      - FLUTTERWAVE_SECRET_KEY=${FLUTTERWAVE_SECRET_KEY}
      - PAYSTACK_SECRET_KEY=${PAYSTACK_SECRET_KEY}
      
      # Monitoring and Performance
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,metrics,prometheus
      - MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS=always
      - MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED=true
      - SERVER_TOMCAT_MAX_THREADS=100
      - SPRING_JPA_HIBERNATE_DDL_AUTO=validate
      - LOGGING_LEVEL_ROOT=INFO
      - LOGGING_LEVEL_COM_WAQITI=INFO
      
    ports:
      - "8084:8080"
    networks:
      - waqiti-staging-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1.5G
          cpus: '0.8'
        reservations:
          memory: 750M
          cpus: '0.3'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.reconciliation-service.rule=Host(`reconciliation-staging.example.com`)"
      - "traefik.http.routers.reconciliation-service.entrypoints=websecure"
      - "traefik.http.routers.reconciliation-service.tls.certresolver=letsencrypt"

  # Nginx Load Balancer & Reverse Proxy
  nginx:
    image: nginx:1.25-alpine
    container_name: waqiti-nginx-staging
    depends_on:
      - payment-service
      - wallet-service
      - fraud-detection-service
      - reconciliation-service
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./ssl:/etc/nginx/ssl:ro
      - nginx-staging-logs:/var/log/nginx
    ports:
      - "80:80"
      - "443:443"
    networks:
      - waqiti-staging-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.1'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Prometheus - Metrics Collection
  prometheus:
    image: prom/prometheus:v2.47.0
    container_name: waqiti-prometheus-staging
    command:
      - '--config.file=/etc/prometheus/prometheus-staging.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--storage.tsdb.retention.size=50GB'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
      - '--web.external-url=https://prometheus-staging.example.com'
    volumes:
      - ./prometheus/prometheus-staging.yml:/etc/prometheus/prometheus-staging.yml:ro
      - ./prometheus/rules:/etc/prometheus/rules:ro
      - prometheus-staging-data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - waqiti-staging-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1'

  # Grafana - Metrics Visualization
  grafana:
    image: grafana/grafana:10.1.2
    container_name: waqiti-grafana-staging
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_SERVER_ROOT_URL=https://grafana-staging.example.com
      - GF_SERVER_DOMAIN=grafana-staging.example.com
      - GF_INSTALL_PLUGINS=grafana-piechart-panel,grafana-worldmap-panel
      - GF_RENDERING_SERVER_URL=http://grafana-renderer:8081/render
      - GF_RENDERING_CALLBACK_URL=http://grafana:3000/
      - GF_ALERTING_ENABLED=true
      - GF_UNIFIED_ALERTING_ENABLED=true
      - GF_SMTP_ENABLED=${SMTP_ENABLED:-false}
      - GF_SMTP_HOST=${SMTP_HOST}
      - GF_SMTP_USER=${SMTP_USER}
      - GF_SMTP_PASSWORD=${SMTP_PASSWORD}
      - GF_SMTP_FROM_ADDRESS=${SMTP_FROM_ADDRESS}
    volumes:
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana/datasources:/etc/grafana/provisioning/datasources:ro
      - grafana-staging-data:/var/lib/grafana
    ports:
      - "3000:3000"
    networks:
      - waqiti-staging-network
    restart: unless-stopped
    depends_on:
      - prometheus
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

volumes:
  postgres-staging-data:
    driver: local
  redis-staging-data:
    driver: local
  kafka-staging-data:
    driver: local
  zookeeper-staging-data:
    driver: local
  zookeeper-staging-logs:
    driver: local
  prometheus-staging-data:
    driver: local
  grafana-staging-data:
    driver: local
  nginx-staging-logs:
    driver: local

networks:
  waqiti-staging-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16